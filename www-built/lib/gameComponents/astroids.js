define(["underscore","box2dCore"],function(e,t){var n=function(t,n){function l(e){var t=new Image;t.src=e,o.push(t)}var r=this;this.ready=!0,this.details=n=n||{};var i=n.sprites,s=n.contactCallback=n.contactCallback||null;this.physics=t,this.MAX_SPEED=this.details.maxSpeed||6,this.MIN_SPEED=this.details.minSpeed||2,this.minRadius=this.details.minRadius||.5,this.maxRadius=this.details.maxRadius||1,this.fragmentMaxFactor=this.details.fragmentMaxFactor||.3,this.fragmentMinFactor=this.details.fragmentMinFactor||.1,this.numberOfFragments=this.details.numberOfFragments||20;var o=[],u=[],a=[],f=1.25*(this.maxRadius+t.screenboundaryThickness/t.scale);e.isUndefined(i)&&(i=["imgs/asteroid_1.png","imgs/asteroid_2.png","imgs/asteroid_3.png","imgs/asteroid_4.png"]),e.each(i,l);var c=function(n,i){if(!o||o.length===0){console.log("Asteroid constructor: No asteroid sprites available");return}var u=e.random(o.length-1),a=Math.random()*r.maxRadius;a<r.minRadius&&(a=r.minRadius),this.body=new Body(t,{id:"asteroid",shape:"circle",x:n.x,y:n.y,image:o[u],radius:a,width:2*a,height:2*a}),this.body.body.ApplyImpulse({x:i.x,y:i.y},this.body.body.GetWorldCenter()),e.isUndefined(s)||(this.body.contact=s)};this.doCcreateAsteroid=function(e,t){var n=new c(e,t);return a.push(n),n},this.destroyAllAsteroids=function(){e.each(a,function(e){t.destroyBody(e.body)}),a=[]},this.doMakeAsteroid=function(){$(window).trigger("asteroidAboutToBeMade"),r.ready&&(r.createAsteroid(r.getRandomPosition(f),r.generateRandomVelocity()),$(window).trigger("asteroidMade"))},this.explodeBody=function(t){e.contains(u,t)||u.push(t)};var h=function(n){var i=n.details.radius*r.fragmentMaxFactor,s=n.details.radius*r.fragmentMinFactor,o=r.numberOfFragments,u=[],a=[],f=[];for(var l=0;l<o;++l){var c=Math.random()*i;c<s&&(c=s);var h=n.body.GetPosition(),p=(i-s)/3;c>s+2*p?u.push(new Body(t,{id:"asteroidFragment",shape:"circle",x:h.x,y:h.y,image:n.details.image,radius:c,width:2*c,height:2*c})):c>s+p?a.push(new Body(t,{id:"asteroidFragment",shape:"circle",x:h.x,y:h.y,image:n.details.image,radius:c,width:2*c,height:2*c})):f.push(new Body(t,{id:"asteroidFragment",shape:"circle",x:h.x,y:h.y,image:n.details.image,radius:c,width:2*c,height:2*c}))}setTimeout(function(){e.each(u,function(e){t.destroyBody(e)})},3e3),setTimeout(function(){e.each(a,function(e){t.destroyBody(e)})},2e3),setTimeout(function(){e.each(f,function(e){t.destroyBody(e)})},1e3)};this.doExplodeBody=function(e){new h(e),t.destroyBody(e),$(window).trigger("asteroidExploded")},$(window).on("step",function(){e.each(u,r.doExplodeBody),u=[]})};return n.prototype.makeAsteroids=function(e){setInterval(this.doMakeAsteroid,e||3e3)},n.prototype.getRandomPosition=function(e){var t=Math.random()*this.physics.element.width/this.physics.scale;return t<e&&(t=e),t>this.physics.element.width/this.physics.scale-e&&(t=this.physics.element.width/this.physics.scale-e),{x:t,y:e}},n.prototype.generateRandomVelocity=function(){var e=Math.random()*Math.PI*2,n=Math.random()*(this.MAX_SPEED-this.MIN_SPEED)+this.MIN_SPEED;return new t.b2Vec2(Math.cos(e)*n,Math.abs(Math.sin(e)*n))},n.prototype.createAsteroid=function(e,t){this.doCcreateAsteroid(e,t)},n});