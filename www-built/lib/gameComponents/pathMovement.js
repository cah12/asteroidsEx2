define(["underscore","jquery","box2dCore"],function(e,t,n){var r=function(r,i){function g(t){var n=0,r=0;e.each(t,function(e){n+=e.x,r+=e.y});if(n!=0||r!=0)t.push({x:-n,y:-r}),d+=1}function y(){a<d&&(a===0?h=c={x:r.body.GetPosition().x,y:r.body.GetPosition().y}:c=p,e.isUndefined(s.path[a])||(p={x:s.path[a].x+c.x,y:s.path[a].y+c.y},l=E(s.path[a].x,s.path[a].y)),b())}function b(){v?u={x:o,y:o}:u={x:s.speed*Math.sin(l*Math.PI/180),y:-s.speed*Math.cos(l*Math.PI/180)},r.body.SetAngle(l*Math.PI/180),r.body.SetLinearVelocity(new n.b2Vec2(u.x,u.y))}function w(e,t){var n=Math.abs(e),r=Math.abs(t),i=Math.abs(e-t);return e==t?!0:e==0||t==0||i<Number.MIN_VALUE?i<s.dEpsilon*Number.MIN_VALUE:i/(n+r)<s.dEpsilon}function E(e,t){if(e==0)return t>0?180:0;if(t==0)return e>0?90:270;var n=Math.atan(-t/e)/(Math.PI/180);return e<0&&t>0?270-n:e<0&&t<0?270-n:e>0&&t<0?90-n:90-n}function S(){return w(f.x,p.x)&&w(f.y,p.y)?!0:!1}function x(){S()&&(a<d?(a++,y()):s.loop?(s.newPath&&(s.path=s.newPath,s.newPath=null),r.body.SetPosition(new n.b2Vec2(h.x,h.y)),a=0,y(),m||(v=!0)):v=!0)}var s=this;this.dEpsilon=i.dEpsilon=i.dEpsilon||.08,this.loop=!1,e.isUndefined(i.loop)||(this.loop=i.loop),this.speed=i.speed=i.speed||2,this.path=i.path=i.path||[],this.newPath=null;var o=.008,u={x:o,y:o},a=0,f=null,l=E(s.path[a].x,s.path[a].y),c=null,h=null,p=null,d=e.size(this.path),v=!1,m=!0;this.loop&&g(this.path),this.setNewPath=function(e){s.newPath=e,this.loop&&g(s.newPath)},this.setRun=function(e){m=e,m&&(v=!1)},t(window).on("step",function(){v||(f=r.body.GetPosition(),x())}),r.body.SetBullet(),y()};return r});