define(["jquery","misc","howler"],function(e,t){var n=function(t,n){function w(){e("#upArrowButton")[0].addEventListener("touchstart",function(e){e.preventDefault(),d=!0},!1),e("#upArrowButton")[0].addEventListener("touchend",function(e){e.preventDefault(),d=!1},!1),e("#downArrowButton")[0].addEventListener("touchstart",function(e){e.preventDefault(),v=!0},!1),e("#downArrowButton")[0].addEventListener("touchend",function(e){e.preventDefault(),v=!1},!1),e("#fireButton")[0].addEventListener("touchstart",function(e){e.preventDefault(),p=!0,r.shoot()},!1),e("#fireButton")[0].addEventListener("touchend",function(e){e.preventDefault(),p=!1},!1)}var r=this,i=t.gamePhysics();this.cannon_baseWidth=n.width=n.width||4.3,this.cannon_baseHeight=n.height=n.height||2.2,this.x=n.x||150/i.scale,this.y=n.y||240/i.scale,this.direction=n.direction||"right",this.enableKeyboard=n.enableKeyboard||!0,this.SPM=n.SPM||300,this.rotationSpeed=n.rotationSpeed||1;var s=n.cannonBase,o=n.cannon;this.direction==="left"&&(s=n.cannonBaseLeft,o=n.cannonLeft);var u=null;if(typeof s=="string")u=new Image,u.src=s;else{u=s;if(u===undefined)throw"Cannon: unable to resolve image"}var a=null;if(typeof o=="string")a=new Image,a.src=o;else{a=o;if(a===undefined)throw"Cannon: unable to resolve image"}this.body_cannon_base=new Body(i,{type:"static",x:this.x,y:this.y,image:u,width:this.cannon_baseWidth,height:this.cannon_baseHeight,draggable:!1});var f=new Howl({urls:["./sounds/cannon.wav"]}),l=new Howl({urls:["./sounds/gear.wav"],volume:.5,loop:!0,onplay:function(){this.isPlaying=!0},onpause:function(){this.isPlaying=!1}});l.isPlaying=!1;var c=35,h=!0,p=!1,d=!1,v=!1,m=this.x+.1*this.cannon_baseWidth;this.direction==="left"&&(m=this.x-.1*this.cannon_baseWidth);var g=this.y-.3*this.cannon_baseHeight;this.body_cannon=new Body(i,{x:m,y:g,image:a,width:.754*this.cannon_baseWidth,height:.55*this.cannon_baseHeight});var y=0,b=130;this.direction==="left"&&(y=-130,b=0),this.joint=i.revoluteJoint(this.body_cannon,this.body_cannon_base,{x:m,y:g},{enableLimit:!0,lowerAngle:y,upperAngle:b,motorSpeed:0,enableMotor:!1,maxMotorTorque:100}),this.joint.EnableMotor(!0),this.raiseCannon=function(){this.direction==="left"?this.joint.SetMotorSpeed(-this.rotationSpeed):this.joint.SetMotorSpeed(this.rotationSpeed),!l.isPlaying&&t.soundEnabled&&l.play()},this.dropCannon=function(){this.direction==="left"?this.joint.SetMotorSpeed(this.rotationSpeed):this.joint.SetMotorSpeed(-this.rotationSpeed),!l.isPlaying&&t.soundEnabled&&l.play()},this.stopCannon=function(){this.joint.SetMotorSpeed(0),l.pause()},w();var E=function(e){e.preventDefault(),e.keyCode==38||e.keyCode==119?d=!0:e.keyCode==40||e.keyCode==115?v=!0:e.keyCode==17?c>5&&(c-=2):e.keyCode==16?c<60&&(c+=2):e.keyCode==32&&(p=!0)},S=function(e){e.preventDefault(),e.keyCode==119?d=!0:e.keyCode==115?v=!0:e.keyCode==17?c>5&&(c-=2):e.keyCode==16&&c<60&&(c+=2)},x=function(e){e.preventDefault(),e.keyCode==32&&(p=!1);if(e.keyCode==38||e.keyCode==119)d=!1;else if(e.keyCode==40||e.keyCode==115)v=!1};this.enableKeyboardControl=function(e){e?(window.addEventListener("keypress",S,!1),window.addEventListener("keydown",E,!1),window.addEventListener("keyup",x,!1)):(window.removeEventListener("keypress",S,!1),window.removeEventListener("keydown",E,!1),window.removeEventListener("keyup",x,!1))},this.isShoot=function(){return p},this.shoot=function(){if(!h||!i.running)return;h=!1;var n=Math.abs(this.joint.GetJointAngle()),r=.55*this.cannon_baseHeight*.18,s=.754*this.cannon_baseWidth,o=(2*r+s*.5)*Math.cos(n);this.direction==="left"&&(o*=-1);var u=(2*r+s*.5)*Math.sin(n),a=new Body(i,{shape:"circle",radius:r,x:m+o,y:g-u,color:"white",id:"ball"});a.contact=function(e,t,n){n.id=="boundary"&&i.destroyBody(this)};var l=c,p=l*Math.cos(n),d=l*Math.sin(n);this.direction==="left"?a.body.ApplyImpulse({x:-p,y:-d},a.body.GetWorldCenter()):a.body.ApplyImpulse({x:p,y:-d},a.body.GetWorldCenter()),t.soundEnabled&&f.play(),setTimeout(function(){h=!0},60/this.SPM*1e3),e(window).trigger("shotFired")},this.destroyCannon=function(){r.enableKeyboardControl(!1),i.destroyBody(this.body_cannon),i.destroyBody(this.body_cannon_base)},e(window).on("step",function(){p&&r.shoot(),d?r.raiseCannon():v?r.dropCannon():(r.joint.SetMotorSpeed(0),r.stopCannon())}),e(window).on("gameEnd",function(){l.pause()}),this.enableKeyboard&&this.enableKeyboardControl(!0)};return n});