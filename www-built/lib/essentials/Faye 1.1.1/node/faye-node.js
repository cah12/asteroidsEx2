/*
Copyright Joyent, Inc. and other Node contributors. All rights reserved.
Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

(function(){"use strict";var e={VERSION:"1.1.1",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:["long-polling","cross-origin-long-polling","callback-polling","websocket","eventsource","in-process"],MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:typeof window!="undefined"?window:global,extend:function(e,t,n){if(!t)return e;for(var r in t){if(!t.hasOwnProperty(r))continue;if(e.hasOwnProperty(r)&&n===!1)continue;e[r]!==t[r]&&(e[r]=t[r])}return e},random:function(e){e=e||this.ID_LENGTH;var t=Math.ceil(e*Math.log(2)/Math.log(36)),n=l(e,36);while(n.length<t)n="0"+n;return n},validateOptions:function(e,t){for(var n in e)if(this.indexOf(t,n)<0)throw new Error("Unrecognized option: "+n)},clientIdFromMessages:function(e){var t=this.filter([].concat(e),function(e){return e.channel==="/meta/connect"});return t[0]&&t[0].clientId},copyObject:function(t){var n,r,i;if(t instanceof Array){n=[],r=t.length;while(r--)n[r]=e.copyObject(t[r]);return n}if(typeof t=="object"){n=t===null?null:{};for(i in t)n[i]=e.copyObject(t[i]);return n}return t},commonElement:function(e,t){for(var n=0,r=e.length;n<r;n++)if(this.indexOf(t,e[n])!==-1)return e[n];return null},indexOf:function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},map:function(e,t,n){if(e.map)return e.map(t,n);var r=[];if(e instanceof Array)for(var i=0,s=e.length;i<s;i++)r.push(t.call(n||null,e[i],i));else for(var o in e){if(!e.hasOwnProperty(o))continue;r.push(t.call(n||null,o,e[o]))}return r},filter:function(e,t,n){if(e.filter)return e.filter(t,n);var r=[];for(var i=0,s=e.length;i<s;i++)t.call(n||null,e[i],i)&&r.push(e[i]);return r},asyncEach:function(e,t,n,r){var i=e.length,s=-1,o=0,u=!1,a=function(){o-=1,s+=1;if(s===i)return n&&n.call(r);t(e[s],l)},f=function(){if(u)return;u=!0;while(o>0)a();u=!1},l=function(){o+=1,f()};l()},toJSON:function(e){return this.stringify?this.stringify(e,function(e,t){return this[e]instanceof Array?this[e]:t}):JSON.stringify(e)}};typeof module!="undefined"?module.exports=e:typeof window!="undefined"&&(window.Faye=e),e.Class=function(t,n){typeof t!="function"&&(n=t,t=Object);var r=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},i=function(){};return i.prototype=t.prototype,r.prototype=new i,e.extend(r.prototype,n),r},function(){function r(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<e.length;n++)if(t===e[n])return n;return-1}var t=e.EventEmitter=function(){},n=typeof Array.isArray=="function"?Array.isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"};t.prototype.emit=function(e){if(e==="error")if(!this._events||!this._events.error||n(this._events.error)&&!this._events.error.length)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var t=this._events[e];if(!t)return!1;if(typeof t=="function"){switch(arguments.length){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;default:var r=Array.prototype.slice.call(arguments,1);t.apply(this,r)}return!0}if(n(t)){var r=Array.prototype.slice.call(arguments,1),i=t.slice();for(var s=0,o=i.length;s<o;s++)i[s].apply(this,r);return!0}return!1},t.prototype.addListener=function(e,t){if("function"!=typeof t)throw new Error("addListener only takes instances of Function");return this._events||(this._events={}),this.emit("newListener",e,t),this._events[e]?n(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(e,t){var n=this;return n.on(e,function r(){n.removeListener(e,r),t.apply(this,arguments)}),this},t.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[e])return this;var i=this._events[e];if(n(i)){var s=r(i,t);if(s<0)return this;i.splice(s,1),i.length==0&&delete this._events[e]}else this._events[e]===t&&delete this._events[e];return this},t.prototype.removeAllListeners=function(e){return arguments.length===0?(this._events={},this):(e&&this._events&&this._events[e]&&(this._events[e]=null),this)},t.prototype.listeners=function(e){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),n(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]}}(),e.Namespace=e.Class({initialize:function(){this._used={}},exists:function(e){return this._used.hasOwnProperty(e)},generate:function(){var t=e.random();while(this._used.hasOwnProperty(t))t=e.random();return this._used[t]=t},release:function(e){delete this._used[e]}}),function(){var t=setTimeout,n;typeof setImmediate=="function"?n=function(e){setImmediate(e)}:typeof process=="object"&&process.nextTick?n=function(e){process.nextTick(e)}:n=function(e){t(e,0)};var r=0,i=1,s=2,o=function(e){return e},u=function(e){throw e},a=function(e){this._state=r,this._onFulfilled=[],this._onRejected=[];if(typeof e!="function")return;var t=this;e(function(e){p(t,e)},function(e){v(t,e)})};a.prototype.then=function(e,t){var n=new a;return f(this,e,n),l(this,t,n),n};var f=function(e,t,n){typeof t!="function"&&(t=o);var s=function(e){c(t,e,n)};e._state===r?e._onFulfilled.push(s):e._state===i&&s(e._value)},l=function(e,t,n){typeof t!="function"&&(t=u);var i=function(e){c(t,e,n)};e._state===r?e._onRejected.push(i):e._state===s&&i(e._reason)},c=function(e,t,r){n(function(){h(e,t,r)})},h=function(e,t,n){var r;try{r=e(t)}catch(i){return v(n,i)}r===n?v(n,new TypeError("Recursive promise chain detected")):p(n,r)},p=a.fulfill=a.resolve=function(e,t){var n=!1,r,i;try{r=typeof t,i=t!==null&&(r==="function"||r==="object")&&t.then;if(typeof i!="function")return d(e,t);i.call(t,function(t){if(!(n^(n=!0)))return;p(e,t)},function(t){if(!(n^(n=!0)))return;v(e,t)})}catch(s){if(!(n^(n=!0)))return;v(e,s)}},d=function(e,t){if(e._state!==r)return;e._state=i,e._value=t,e._onRejected=[];var n=e._onFulfilled,s;while(s=n.shift())s(t)},v=a.reject=function(e,t){if(e._state!==r)return;e._state=s,e._reason=t,e._onFulfilled=[];var n=e._onRejected,i;while(i=n.shift())i(t)};a.all=function(e){return new a(function(t,n){var r=[],i=e.length,s;if(i===0)return t(r);for(s=0;s<i;s++)(function(e,s){a.fulfilled(e).then(function(e){r[s]=e,--i===0&&t(r)},n)})(e[s],s)})},a.defer=n,a.deferred=a.pending=function(){var e={};return e.promise=new a(function(t,n){e.fulfill=e.resolve=t,e.reject=n}),e},a.fulfilled=a.resolved=function(e){return new a(function(t,n){t(e)})},a.rejected=function(e){return new a(function(t,n){n(e)})},typeof e=="undefined"?module.exports=a:e.Promise=a}(),e.Set=e.Class({initialize:function(){this._index={}},add:function(e){var t=e.id!==undefined?e.id:e;return this._index.hasOwnProperty(t)?!1:(this._index[t]=e,!0)},forEach:function(e,t){for(var n in this._index)this._index.hasOwnProperty(n)&&e.call(t,this._index[n])},isEmpty:function(){for(var e in this._index)if(this._index.hasOwnProperty(e))return!1;return!0},member:function(e){for(var t in this._index)if(this._index[t]===e)return!0;return!1},remove:function(e){var t=e.id!==undefined?e.id:e,n=this._index[t];return delete this._index[t],n},toArray:function(){var e=[];return this.forEach(function(t){e.push(t)}),e}}),e.URI={isURI:function(e){return e&&e.protocol&&e.host&&e.path},isSameOrigin:function(t){var n=e.ENV.location;return t.protocol===n.protocol&&t.hostname===n.hostname&&t.port===n.port},parse:function(t){if(typeof t!="string")return t;var n={},r,i,s,o,u,a,f=function(e,r){t=t.replace(r,function(t){return n[e]=t,""}),n[e]=n[e]||""};f("protocol",/^[a-z]+\:/i),f("host",/^\/\/[^\/\?#]+/),!/^\//.test(t)&&!n.host&&(t=e.ENV.location.pathname.replace(/[^\/]*$/,"")+t),f("pathname",/^[^\?#]*/),f("search",/^\?[^#]*/),f("hash",/^#.*/),n.protocol=n.protocol||e.ENV.location.protocol,n.host?(n.host=n.host.substr(2),r=n.host.split(":"),n.hostname=r[0],n.port=r[1]||""):(n.host=e.ENV.location.host,n.hostname=e.ENV.location.hostname,n.port=e.ENV.location.port),n.pathname=n.pathname||"/",n.path=n.pathname+n.search,i=n.search.replace(/^\?/,""),s=i?i.split("&"):[],a={};for(o=0,u=s.length;o<u;o++)r=s[o].split("="),a[decodeURIComponent(r[0]||"")]=decodeURIComponent(r[1]||"");return n.query=a,n.href=this.stringify(n),n},stringify:function(e){var t=e.protocol+"//"+e.hostname;return e.port&&(t+=":"+e.port),t+=e.pathname+this.queryString(e.query)+(e.hash||""),t},queryString:function(e){var t=[];for(var n in e){if(!e.hasOwnProperty(n))continue;t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]))}return t.length===0?"":"?"+t.join("&")}},e.Error=e.Class({initialize:function(e,t,n){this.code=e,this.params=Array.prototype.slice.call(t),this.message=n},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),e.Error.parse=function(t){t=t||"";if(!e.Grammar.ERROR.test(t))return new this(null,[],t);var n=t.split(":"),r=parseInt(n[0]),i=n[1].split(","),t=n[2];return new this(r,i,t)},e.Error.versionMismatch=function(){return(new this(300,arguments,"Version mismatch")).toString()},e.Error.conntypeMismatch=function(){return(new this(301,arguments,"Connection types not supported")).toString()},e.Error.extMismatch=function(){return(new this(302,arguments,"Extension mismatch")).toString()},e.Error.badRequest=function(){return(new this(400,arguments,"Bad request")).toString()},e.Error.clientUnknown=function(){return(new this(401,arguments,"Unknown client")).toString()},e.Error.parameterMissing=function(){return(new this(402,arguments,"Missing required parameter")).toString()},e.Error.channelForbidden=function(){return(new this(403,arguments,"Forbidden channel")).toString()},e.Error.channelUnknown=function(){return(new this(404,arguments,"Unknown channel")).toString()},e.Error.channelInvalid=function(){return(new this(405,arguments,"Invalid channel")).toString()},e.Error.extUnknown=function(){return(new this(406,arguments,"Unknown extension")).toString()},e.Error.publishFailed=function(){return(new this(407,arguments,"Failed to publish")).toString()},e.Error.serverError=function(){return(new this(500,arguments,"Internal server error")).toString()},e.Deferrable={then:function(t,n){var r=this;return this._promise||(this._promise=new e.Promise(function(e,t){r._fulfill=e,r._reject=t})),arguments.length===0?this._promise:this._promise.then(t,n)},callback:function(e,t){return this.then(function(n){e.call(t,n)})},errback:function(e,t){return this.then(null,function(n){e.call(t,n)})},timeout:function(t,n){this.then();var r=this;this._timer=e.ENV.setTimeout(function(){r._reject(n)},t*1e3)},setDeferredStatus:function(t,n){this._timer&&e.ENV.clearTimeout(this._timer),this.then(),t==="succeeded"?this._fulfill(n):t==="failed"?this._reject(n):delete this._promise}},e.Publisher={countListeners:function(e){return this.listeners(e).length},bind:function(e,t,n){var r=Array.prototype.slice,i=function(){t.apply(n,r.call(arguments))};return this._listeners=this._listeners||[],this._listeners.push([e,t,n,i]),this.on(e,i)},unbind:function(e,t,n){this._listeners=this._listeners||[];var r=this._listeners.length,i;while(r--){i=this._listeners[r];if(i[0]!==e)continue;if(!(!t||i[1]===t&&i[2]===n))continue;this._listeners.splice(r,1),this.removeListener(e,i[3])}}},e.extend(e.Publisher,e.EventEmitter.prototype),e.Publisher.trigger=e.Publisher.emit,e.Timeouts={addTimeout:function(t,n,r,i){this._timeouts=this._timeouts||{};if(this._timeouts.hasOwnProperty(t))return;var s=this;this._timeouts[t]=e.ENV.setTimeout(function(){delete s._timeouts[t],r.call(i)},1e3*n)},removeTimeout:function(t){this._timeouts=this._timeouts||{};var n=this._timeouts[t];if(!n)return;e.ENV.clearTimeout(n),delete this._timeouts[t]},removeAllTimeouts:function(){this._timeouts=this._timeouts||{};for(var e in this._timeouts)this.removeTimeout(e)}},e.Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function(t,n){if(!e.logger)return;var r=Array.prototype.slice.apply(t),i="[Faye",s=this.className,o=r.shift().replace(/\?/g,function(){try{return e.toJSON(r.shift())}catch(t){return"[Object]"}});for(var u in e){if(s)continue;if(typeof e[u]!="function")continue;this instanceof e[u]&&(s=u)}s&&(i+="."+s),i+="] ",typeof e.logger[n]=="function"?e.logger[n](i+o):typeof e.logger=="function"&&e.logger(i+o)}},function(){for(var t in e.Logging.LOG_LEVELS)(function(t){e.Logging[t]=function(){this.writeLog(arguments,t)}})(t)}(),e.Grammar={CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/},e.Extensible={addExtension:function(e){this._extensions=this._extensions||[],this._extensions.push(e),e.added&&e.added(this)},removeExtension:function(e){if(!this._extensions)return;var t=this._extensions.length;while(t--){if(this._extensions[t]!==e)continue;this._extensions.splice(t,1),e.removed&&e.removed(this)}},pipeThroughExtensions:function(e,t,n,r,i){this.debug("Passing through ? extensions: ?",e,t);if(!this._extensions)return r.call(i,t);var s=this._extensions.slice(),o=function(t){if(!t)return r.call(i,t);var u=s.shift();if(!u)return r.call(i,t);var a=u[e];if(!a)return o(t);a.length>=3?u[e](t,n,o):u[e](t,o)};o(t)}},e.extend(e.Extensible,e.Logging),e.Channel=e.Class({initialize:function(e){this.id=this.name=e},push:function(e){this.trigger("message",e)},isUnused:function(){return this.countListeners("message")===0}}),e.extend(e.Channel.prototype,e.Publisher),e.extend(e.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(e){var t=this.parse(e),n=["/**",e],r=t.slice();r[r.length-1]="*",n.push(this.unparse(r));for(var i=1,s=t.length;i<s;i++)r=t.slice(0,i),r.push("**"),n.push(this.unparse(r));return n},isValid:function(t){return e.Grammar.CHANNEL_NAME.test(t)||e.Grammar.CHANNEL_PATTERN.test(t)},parse:function(e){return this.isValid(e)?e.split("/").slice(1):null},unparse:function(e){return"/"+e.join("/")},isMeta:function(e){var t=this.parse(e);return t?t[0]===this.META:null},isService:function(e){var t=this.parse(e);return t?t[0]===this.SERVICE:null},isSubscribable:function(e){return this.isValid(e)?!this.isMeta(e)&&!this.isService(e):null},Set:e.Class({initialize:function(){this._channels={}},getKeys:function(){var e=[];for(var t in this._channels)e.push(t);return e},remove:function(e){delete this._channels[e]},hasSubscription:function(e){return this._channels.hasOwnProperty(e)},subscribe:function(t,n,r){var i;for(var s=0,o=t.length;s<o;s++){i=t[s];var u=this._channels[i]=this._channels[i]||new e.Channel(i);n&&u.bind("message",n,r)}},unsubscribe:function(e,t,n){var r=this._channels[e];return r?(r.unbind("message",t,n),r.isUnused()?(this.remove(e),!0):!1):!1},distributeMessage:function(t){var n=e.Channel.expand(t.channel);for(var r=0,i=n.length;r<i;r++){var s=this._channels[n[r]];s&&s.trigger("message",t.data)}}})}),e.Publication=e.Class(e.Deferrable),e.Subscription=e.Class({initialize:function(e,t,n,r){this._client=e,this._channels=t,this._callback=n,this._context=r,this._cancelled=!1},cancel:function(){if(this._cancelled)return;this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0},unsubscribe:function(){this.cancel()}}),e.extend(e.Subscription.prototype,e.Deferrable),e.Client=e.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(t,n){this.info("New client created for ?",t),n=n||{},e.validateOptions(n,["interval","timeout","endpoints","proxy","retry","scheduler","websocketExtensions","tls","ca"]),this._endpoint=t||this.DEFAULT_ENDPOINT,this._channels=new e.Channel.Set,this._dispatcher=new e.Dispatcher(this,this._endpoint,n),this._messageId=0,this._state=this.UNCONNECTED,this._responseCallbacks={},this._advice={reconnect:this.RETRY,interval:1e3*(n.interval||this.INTERVAL),timeout:1e3*(n.timeout||this.CONNECTION_TIMEOUT)},this._dispatcher.timeout=this._advice.timeout/1e3,this._dispatcher.bind("message",this._receiveMessage,this),e.Event&&e.ENV.onbeforeunload!==undefined&&e.Event.on(e.ENV,"beforeunload",function(){e.indexOf(this._dispatcher._disabled,"autodisconnect")<0&&this.disconnect()},this)},addWebsocketExtension:function(e){return this._dispatcher.addWebsocketExtension(e)},disable:function(e){return this._dispatcher.disable(e)},setHeader:function(e,t){return this._dispatcher.setHeader(e,t)},handshake:function(t,n){if(this._advice.reconnect===this.NONE)return;if(this._state!==this.UNCONNECTED)return;this._state=this.CONNECTING;var r=this;this.info("Initiating handshake with ?",e.URI.stringify(this._endpoint)),this._dispatcher.selectTransport(e.MANDATORY_CONNECTION_TYPES),this._sendMessage({channel:e.Channel.HANDSHAKE,version:e.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},function(i){i.successful?(this._state=this.CONNECTED,this._dispatcher.clientId=i.clientId,this._dispatcher.selectTransport(i.supportedConnectionTypes),this.info("Handshake successful: ?",this._dispatcher.clientId),this.subscribe(this._channels.getKeys(),!0),t&&e.Promise.defer(function(){t.call(n)})):(this.info("Handshake unsuccessful"),e.ENV.setTimeout(function(){r.handshake(t,n)},this._dispatcher.retry*1e3),this._state=this.UNCONNECTED)},this)},connect:function(t,n){if(this._advice.reconnect===this.NONE)return;if(this._state===this.DISCONNECTED)return;if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(t,n)},this);this.callback(t,n);if(this._state!==this.CONNECTED)return;this.info("Calling deferred actions for ?",this._dispatcher.clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("unknown");if(this._connectRequest)return;this._connectRequest=!0,this.info("Initiating connection for ?",this._dispatcher.clientId),this._sendMessage({channel:e.Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this)},disconnect:function(){if(this._state!==this.CONNECTED)return;this._state=this.DISCONNECTED,this.info("Disconnecting ?",this._dispatcher.clientId);var t=new e.Publication;return this._sendMessage({channel:e.Channel.DISCONNECT,clientId:this._dispatcher.clientId},{},function(n){n.successful?(this._dispatcher.close(),t.setDeferredStatus("succeeded")):t.setDeferredStatus("failed",e.Error.parse(n.error))},this),this.info("Clearing channel listeners for ?",this._dispatcher.clientId),this._channels=new e.Channel.Set,t},subscribe:function(t,n,r){if(t instanceof Array)return e.map(t,function(e){return this.subscribe(e,n,r)},this);var i=new e.Subscription(this,t,n,r),s=n===!0,o=this._channels.hasSubscription(t);return o&&!s?(this._channels.subscribe([t],n,r),i.setDeferredStatus("succeeded"),i):(this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._dispatcher.clientId,t),s||this._channels.subscribe([t],n,r),this._sendMessage({channel:e.Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:t},{},function(s){if(!s.successful)return i.setDeferredStatus("failed",e.Error.parse(s.error)),this._channels.unsubscribe(t,n,r);var o=[].concat(s.subscription);this.info("Subscription acknowledged for ? to ?",this._dispatcher.clientId,o),i.setDeferredStatus("succeeded")},this)},this),i)},unsubscribe:function(t,n,r){if(t instanceof Array)return e.map(t,function(e){return this.unsubscribe(e,n,r)},this);var i=this._channels.unsubscribe(t,n,r);if(!i)return;this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._dispatcher.clientId,t),this._sendMessage({channel:e.Channel.UNSUBSCRIBE,clientId:this._dispatcher.clientId,subscription:t},{},function(e){if(!e.successful)return;var t=[].concat(e.subscription);this.info("Unsubscription acknowledged for ? from ?",this._dispatcher.clientId,t)},this)},this)},publish:function(t,n,r){e.validateOptions(r||{},["attempts","deadline"]);var i=new e.Publication;return this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._dispatcher.clientId,t,n),this._sendMessage({channel:t,data:n,clientId:this._dispatcher.clientId},r,function(t){t.successful?i.setDeferredStatus("succeeded"):i.setDeferredStatus("failed",e.Error.parse(t.error))},this)},this),i},_sendMessage:function(e,t,n,r){e.id=this._generateMessageId();var i=this._advice.timeout?1.2*this._advice.timeout/1e3:1.2*this._dispatcher.retry;this.pipeThroughExtensions("outgoing",e,null,function(e){if(!e)return;n&&(this._responseCallbacks[e.id]=[n,r]),this._dispatcher.sendMessage(e,i,t||{})},this)},_generateMessageId:function(){return this._messageId+=1,this._messageId>=Math.pow(2,32)&&(this._messageId=0),this._messageId.toString(36)},_receiveMessage:function(e){var t=e.id,n;e.successful!==undefined&&(n=this._responseCallbacks[t],delete this._responseCallbacks[t]),this.pipeThroughExtensions("incoming",e,null,function(e){if(!e)return;e.advice&&this._handleAdvice(e.advice),this._deliverMessage(e),n&&n[0].call(n[1],e)},this)},_handleAdvice:function(t){e.extend(this._advice,t),this._dispatcher.timeout=this._advice.timeout/1e3,this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=this.UNCONNECTED,this._dispatcher.clientId=null,this._cycleConnection())},_deliverMessage:function(e){if(!e.channel||e.data===undefined)return;this.info("Client ? calling listeners for ? with ?",this._dispatcher.clientId,e.channel,e.data),this._channels.distributeMessage(e)},_cycleConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._dispatcher.clientId));var t=this;e.ENV.setTimeout(function(){t.connect()},this._advice.interval)}}),e.extend(e.Client.prototype,e.Deferrable),e.extend(e.Client.prototype,e.Publisher),e.extend(e.Client.prototype,e.Logging),e.extend(e.Client.prototype,e.Extensible),e.Dispatcher=e.Class({MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,DOWN:2,initialize:function(t,n,r){this._client=t,this.endpoint=e.URI.parse(n),this._alternates=r.endpoints||{},this.cookies=e.Cookies&&new e.Cookies.CookieJar,this._disabled=[],this._envelopes={},this.headers={},this.retry=r.retry||this.DEFAULT_RETRY,this._scheduler=r.scheduler||e.Scheduler,this._state=0,this.transports={},this.wsExtensions=[],this.proxy=r.proxy||{},typeof this._proxy=="string"&&(this._proxy={origin:this._proxy});var i=r.websocketExtensions;if(i){i=[].concat(i);for(var s=0,o=i.length;s<o;s++)this.addWebsocketExtension(i[s])}this.tls=r.tls||{},this.tls.ca=this.tls.ca||r.ca;for(var u in this._alternates)this._alternates[u]=e.URI.parse(this._alternates[u]);this.maxRequestSize=this.MAX_REQUEST_SIZE},endpointFor:function(e){return this._alternates[e]||this.endpoint},addWebsocketExtension:function(e){this.wsExtensions.push(e)},disable:function(e){this._disabled.push(e)},setHeader:function(e,t){this.headers[e]=t},close:function(){var e=this._transport;delete this._transport,e&&e.close()},getConnectionTypes:function(){return e.Transport.getConnectionTypes()},selectTransport:function(t){e.Transport.get(this,t,this._disabled,function(t){this.debug("Selected ? transport for ?",t.connectionType,e.URI.stringify(t.endpoint));if(t===this._transport)return;this._transport&&this._transport.close(),this._transport=t,this.connectionType=t.connectionType},this)},sendMessage:function(e,t,n){n=n||{};var r=e.id,i=n.attempts,s=n.deadline&&(new Date).getTime()+n.deadline*1e3,o=this._envelopes[r],u;o||(u=new this._scheduler(e,{timeout:t,interval:this.retry,attempts:i,deadline:s}),o=this._envelopes[r]={message:e,scheduler:u}),this._sendEnvelope(o)},_sendEnvelope:function(t){if(!this._transport)return;if(t.request||t.timer)return;var n=t.message,r=t.scheduler,i=this;if(!r.isDeliverable()){r.abort(),delete this._envelopes[n.id];return}t.timer=e.ENV.setTimeout(function(){i.handleError(n)},r.getTimeout()*1e3),r.send(),t.request=this._transport.sendMessage(n)},handleResponse:function(t){var n=this._envelopes[t.id];t.successful!==undefined&&n&&(n.scheduler.succeed(),delete this._envelopes[t.id],e.ENV.clearTimeout(n.timer)),this.trigger("message",t);if(this._state===this.UP)return;this._state=this.UP,this._client.trigger("transport:up")},handleError:function(t,n){var r=this._envelopes[t.id],i=r&&r.request,s=this;if(!i)return;i.then(function(e){e&&e.abort&&e.abort()});var o=r.scheduler;o.fail(),e.ENV.clearTimeout(r.timer),r.request=r.timer=null,n?this._sendEnvelope(r):r.timer=e.ENV.setTimeout(function(){r.timer=null,s._sendEnvelope(r)},o.getInterval()*1e3);if(this._state===this.DOWN)return;this._state=this.DOWN,this._client.trigger("transport:down")}}),e.extend(e.Dispatcher.prototype,e.Publisher),e.extend(e.Dispatcher.prototype,e.Logging),e.Scheduler=function(e,t){this.message=e,this.options=t,this.attempts=0},e.extend(e.Scheduler.prototype,{getTimeout:function(){return this.options.timeout},getInterval:function(){return this.options.interval},isDeliverable:function(){var e=this.options.attempts,t=this.attempts,n=this.options.deadline,r=(new Date).getTime();return e!==undefined&&t>=e?!1:n!==undefined&&r>n?!1:!0},send:function(){this.attempts+=1},succeed:function(){},fail:function(){},abort:function(){}}),e.Transport=e.extend(e.Class({DEFAULT_PORTS:{"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS:["https:","wss:"],MAX_DELAY:0,batching:!0,initialize:function(t,n){this._dispatcher=t,this.endpoint=n,this._outbox=[],this._proxy=e.extend({},this._dispatcher.proxy),!this._proxy.origin&&e.NodeAdapter&&(this._proxy.origin=e.indexOf(this.SECURE_PROTOCOLS,this.endpoint.protocol)>=0?process.env.HTTPS_PROXY||process.env.https_proxy:process.env.HTTP_PROXY||process.env.http_proxy)},close:function(){},encode:function(e){return""},sendMessage:function(t){return this.debug("Client ? sending message to ?: ?",this._dispatcher.clientId,e.URI.stringify(this.endpoint),t),this.batching?(this._outbox.push(t),this._flushLargeBatch(),this._promise=this._promise||new e.Promise,t.channel===e.Channel.HANDSHAKE?(this.addTimeout("publish",.01,this._flush,this),this._promise):(t.channel===e.Channel.CONNECT&&(this._connectMessage=t),this.addTimeout("publish",this.MAX_DELAY,this._flush,this),this._promise)):e.Promise.fulfilled(this.request([t]))},_flush:function(){this.removeTimeout("publish"),this._outbox.length>1&&this._connectMessage&&(this._connectMessage.advice={timeout:0}),e.Promise.fulfill(this._promise,this.request(this._outbox)),delete this._promise,this._connectMessage=null,this._outbox=[]},_flushLargeBatch:function(){var e=this.encode(this._outbox);if(e.length<this._dispatcher.maxRequestSize)return;var t=this._outbox.pop();this._flush(),t&&this._outbox.push(t)},_receive:function(t){if(!t)return;t=[].concat(t),this.debug("Client ? received from ? via ?: ?",this._dispatcher.clientId,e.URI.stringify(this.endpoint),this.connectionType,t);for(var n=0,r=t.length;n<r;n++)this._dispatcher.handleResponse(t[n])},_handleError:function(t,n){t=[].concat(t),this.debug("Client ? failed to send to ? via ?: ?",this._dispatcher.clientId,e.URI.stringify(this.endpoint),this.connectionType,t);for(var r=0,i=t.length;r<i;r++)this._dispatcher.handleError(t[r])},_getCookies:function(){var t=this._dispatcher.cookies,n=e.URI.stringify(this.endpoint);return t?e.map(t.getCookiesSync(n),function(e){return e.cookieString()}).join("; "):""},_storeCookies:function(t){var n=this._dispatcher.cookies,r=e.URI.stringify(this.endpoint),i;if(!t||!n)return;t=[].concat(t);for(var s=0,o=t.length;s<o;s++)i=e.Cookies.Cookie.parse(t[s]),n.setCookieSync(i,r)}}),{get:function(t,n,r,i,s){var o=t.endpoint;e.asyncEach(this._transports,function(o,u){var a=o[0],f=o[1],l=t.endpointFor(a);if(e.indexOf(r,a)>=0)return u();if(e.indexOf(n,a)<0)return f.isUsable(t,l,function(){}),u();f.isUsable(t,l,function(e){if(!e)return u();var n=f.hasOwnProperty("create")?f.create(t,l):new f(t,l);i.call(s,n)})},function(){throw new Error("Could not find a usable connection type for "+e.URI.stringify(o))})},register:function(e,t){this._transports.push([e,t]),t.prototype.connectionType=e},getConnectionTypes:function(){return e.map(this._transports,function(e){return e[0]})},_transports:[]}),e.extend(e.Transport.prototype,e.Logging),e.extend(e.Transport.prototype,e.Timeouts),e.Engine={get:function(t){return new e.Engine.Proxy(t)},METHODS:["createClient","clientExists","destroyClient","ping","subscribe","unsubscribe"]},e.Engine.Proxy=e.Class({MAX_DELAY:0,INTERVAL:0,TIMEOUT:60,className:"Engine",initialize:function(t){this._options=t||{},this._connections={},this.interval=this._options.interval||this.INTERVAL,this.timeout=this._options.timeout||this.TIMEOUT;var n=this._options.type||e.Engine.Memory;this._engine=n.create(this,this._options),this.bind("close",function(t){var n=this;e.Promise.defer(function(){n.flushConnection(t)})},this),this.debug("Created new engine: ?",this._options)},connect:function(e,t,n,r){this.debug("Accepting connection from ?",e),this._engine.ping(e);var i=this.connection(e,!0);i.connect(t,n,r),this._engine.emptyQueue(e)},hasConnection:function(e){return this._connections.hasOwnProperty(e)},connection:function(t,n){var r=this._connections[t];return r||!n?r:(this._connections[t]=new e.Engine.Connection(this,t),this.trigger("connection:open",t),this._connections[t])},closeConnection:function(e){this.debug("Closing connection for ?",e);var t=this._connections[e];if(!t)return;t.socket&&t.socket.close(),this.trigger("connection:close",e),delete this._connections[e]},openSocket:function(e,t){var n=this.connection(e,!0);n.socket=t},deliver:function(e,t){if(!t||t.length===0)return!1;var n=this.connection(e,!1);if(!n)return!1;for(var r=0,i=t.length;r<i;r++)n.deliver(t[r]);return!0},generateId:function(){return e.random()},flushConnection:function(e,t){if(!e)return;this.debug("Flushing connection for ?",e);var n=this.connection(e,!1);if(!n)return;t===!1&&(n.socket=null),n.flush(),this.closeConnection(e)},close:function(){for(var e in this._connections)this.flushConnection(e);this._engine.disconnect()},disconnect:function(){if(this._engine.disconnect)return this._engine.disconnect()},publish:function(t){var n=e.Channel.expand(t.channel);return this._engine.publish(t,n)}}),e.Engine.METHODS.forEach(function(t){e.Engine.Proxy.prototype[t]=function(){return this._engine[t].apply(this._engine,arguments)}}),e.extend(e.Engine.Proxy.prototype,e.Publisher),e.extend(e.Engine.Proxy.prototype,e.Logging),e.Engine.Connection=e.Class({initialize:function(e,t,n){this._engine=e,this._id=t,this._options=n,this._inbox=[]},deliver:function(e){delete e.clientId;if(this.socket)return this.socket.send(e);this._inbox.push(e),this._beginDeliveryTimeout()},connect:function(e,t,n){e=e||{};var r=e.timeout!==undefined?e.timeout/1e3:this._engine.timeout;this.setDeferredStatus("unknown"),this.callback(t,n),this._beginDeliveryTimeout(),this._beginConnectionTimeout(r)},flush:function(){this.removeTimeout("connection"),this.removeTimeout("delivery"),this.setDeferredStatus("succeeded",this._inbox),this._inbox=[],this.socket||this._engine.closeConnection(this._id)},_beginDeliveryTimeout:function(){if(this._inbox.length===0)return;this.addTimeout("delivery",this._engine.MAX_DELAY,this.flush,this)},_beginConnectionTimeout:function(e){this.addTimeout("connection",e,this.flush,this)}}),e.extend(e.Engine.Connection.prototype,e.Deferrable),e.extend(e.Engine.Connection.prototype,e.Timeouts),e.Engine.Memory=function(e,t){this._server=e,this._options=t||{},this.reset()},e.Engine.Memory.create=function(e,t){return new this(e,t)},e.Engine.Memory.prototype={disconnect:function(){this.reset(),this.removeAllTimeouts()},reset:function(){this._namespace=new e.Namespace,this._clients={},this._channels={},this._messages={}},createClient:function(e,t){var n=this._namespace.generate();this._server.debug("Created new client ?",n),this.ping(n),this._server.trigger("handshake",n),e.call(t,n)},destroyClient:function(e,t,n){if(!this._namespace.exists(e))return;var r=this._clients;r[e]&&r[e].forEach(function(t){this.unsubscribe(e,t)},this),this.removeTimeout(e),this._namespace.release(e),delete this._messages[e],this._server.debug("Destroyed client ?",e),this._server.trigger("disconnect",e),this._server.trigger("close",e),t&&t.call(n)},clientExists:function(e,t,n){t.call(n,this._namespace.exists(e))},ping:function(e){var t=this._server.timeout;if(typeof t!="number")return;this._server.debug("Ping ?, ?",e,t),this.removeTimeout(e),this.addTimeout(e,2*t,function(){this.destroyClient(e)},this)},subscribe:function(t,n,r,i){var s=this._clients,o=this._channels;s[t]=s[t]||new e.Set;var u=s[t].add(n);o[n]=o[n]||new e.Set,o[n].add(t),this._server.debug("Subscribed client ? to channel ?",t,n),u&&this._server.trigger("subscribe",t,n),r&&r.call(i,!0)},unsubscribe:function(e,t,n,r){var i=this._clients,s=this._channels,o=!1;i[e]&&(o=i[e].remove(t),i[e].isEmpty()&&delete i[e]),s[t]&&(s[t].remove(e),s[t].isEmpty()&&delete s[t]),this._server.debug("Unsubscribed client ? from channel ?",e,t),o&&this._server.trigger("unsubscribe",e,t),n&&n.call(r,!0)},publish:function(t,n){this._server.debug("Publishing message ?",t);var r=this._messages,i=new e.Set,s;for(var o=0,u=n.length;o<u;o++){s=this._channels[n[o]];if(!s)continue;s.forEach(i.add,i)}i.forEach(function(n){this._server.debug("Queueing for client ?: ?",n,t),r[n]=r[n]||[],r[n].push(e.copyObject(t)),this.emptyQueue(n)},this),this._server.trigger("publish",t.clientId,t.channel,t.data)},emptyQueue:function(e){if(!this._server.hasConnection(e))return;this._server.deliver(e,this._messages[e]),delete this._messages[e]}},e.extend(e.Engine.Memory.prototype,e.Timeouts),e.Server=e.Class({META_METHODS:["handshake","connect","disconnect","subscribe","unsubscribe"],initialize:function(t){this._options=t||{};var n=this._options.engine||{};n.timeout=this._options.timeout,this._engine=e.Engine.get(n),this.info("Created new server: ?",this._options)},close:function(){return this._engine.close()},openSocket:function(t,n,r){if(!t||!n)return;this._engine.openSocket(t,new e.Server.Socket(this,n,r))},closeSocket:function(e,t){this._engine.flushConnection(e,t)},process:function(e,t,n,r){var i=t===null;e=[].concat(e),this.info("Processing messages: ? (local: ?)",e,i);if(e.length===0)return n.call(r,[]);var s=0,o=[],u=this,a=function(t){o=o.concat(t),s+=1;if(s<e.length)return;var i=o.length;while(i--)o[i]||o.splice(i,1);u.info("Returning replies: ?",o),n.call(r,o)},f=function(e){var n=0,r=e.length;r===0&&a(e);for(var i=0,s=e.length;i<s;i++)this.debug("Processing reply: ?",e[i]),function(i){u.pipeThroughExtensions("outgoing",e[i],t,function(t){e[i]=t,n+=1,n===r&&a(e)})}(i)};for(var l=0,c=e.length;l<c;l++)this.pipeThroughExtensions("incoming",e[l],t,function(e){this._handle(e,i,f,this)},this)},_makeResponse:function(e){var t={};return e.id&&(t.id=e.id),e.clientId&&(t.clientId=e.clientId),e.channel&&(t.channel=e.channel),e.error&&(t.error=e.error),t.successful=!t.error,t},_handle:function(t,n,r,i){if(!t)return r.call(i,[]);this.info("Handling message: ? (local: ?)",t,n);var s=t.channel,o=t.error,u;if(e.Channel.isMeta(s))return this._handleMeta(t,n,r,i);e.Grammar.CHANNEL_NAME.test(s)||(o=e.Error.channelInvalid(s)),o||this._engine.publish(t),u=this._makeResponse(t),o&&(u.error=o),u.successful=!u.error,r.call(i,[u])},_handleMeta:function(t,n,r,i){var s=e.Channel.parse(t.channel)[1],o;if(e.indexOf(this.META_METHODS,s)<0)return o=this._makeResponse(t),o.error=e.Error.channelForbidden(t.channel),o.successful=!1,r.call(i,[o]);this[s](t,n,function(e){e=[].concat(e);for(var n=0,s=e.length;n<s;n++)this._advize(e[n],t.connectionType);r.call(i,e)},this)},_advize:function(t,n){if(e.indexOf([e.Channel.HANDSHAKE,e.Channel.CONNECT],t.channel)<0)return;var r,i;n==="eventsource"?(r=Math.floor(this._engine.timeout*1e3),i=0):(r=Math.floor(this._engine.interval*1e3),i=Math.floor(this._engine.timeout*1e3)),t.advice=t.advice||{},t.error?e.extend(t.advice,{reconnect:"handshake"},!1):e.extend(t.advice,{reconnect:"retry",interval:r,timeout:i},!1)},handshake:function(t,n,r,i){var s=this._makeResponse(t);s.version=e.BAYEUX_VERSION,t.version||(s.error=e.Error.parameterMissing("version"));var o=t.supportedConnectionTypes,u;s.supportedConnectionTypes=e.CONNECTION_TYPES,o?(u=e.filter(o,function(t){return e.indexOf(e.CONNECTION_TYPES,t)>=0}),u.length===0&&(s.error=e.Error.conntypeMismatch(o))):s.error=e.Error.parameterMissing("supportedConnectionTypes"),s.successful=!s.error;if(!s.successful)return r.call(i,s);this._engine.createClient(function(e){s.clientId=e,r.call(i,s)},this)},connect:function(t,n,r,i){var s=this._makeResponse(t),o=t.clientId,u=t.connectionType;this._engine.clientExists(o,function(n){n||(s.error=e.Error.clientUnknown(o)),o||(s.error=e.Error.parameterMissing("clientId")),e.indexOf(e.CONNECTION_TYPES,u)<0&&(s.error=e.Error.conntypeMismatch(u)),u||(s.error=e.Error.parameterMissing("connectionType")),s.successful=!s.error;if(!s.successful)return delete s.clientId,r.call(i,s);t.connectionType==="eventsource"&&(t.advice=t.advice||{},t.advice.timeout=0),this._engine.connect(s.clientId,t.advice,function(e){r.call(i,[s].concat(e))})},this)},disconnect:function(t,n,r,i){var s=this._makeResponse(t),o=t.clientId;this._engine.clientExists(o,function(t){t||(s.error=e.Error.clientUnknown(o)),o||(s.error=e.Error.parameterMissing("clientId")),s.successful=!s.error,s.successful||delete s.clientId,s.successful&&this._engine.destroyClient(o),r.call(i,s)},this)},subscribe:function(t,n,r,i){var s=this._makeResponse(t),o=t.clientId,u=t.subscription,a;u=u?[].concat(u):[],this._engine.clientExists(o,function(f){f||(s.error=e.Error.clientUnknown(o)),o||(s.error=e.Error.parameterMissing("clientId")),t.subscription||(s.error=e.Error.parameterMissing("subscription")),s.subscription=t.subscription||[];for(var l=0,c=u.length;l<c;l++){a=u[l];if(s.error)break;!n&&!e.Channel.isSubscribable(a)&&(s.error=e.Error.channelForbidden(a)),e.Channel.isValid(a)||(s.error=e.Error.channelInvalid(a));if(s.error)break;this._engine.subscribe(o,a)}s.successful=!s.error,r.call(i,s)},this)},unsubscribe:function(t,n,r,i){var s=this._makeResponse(t),o=t.clientId,u=t.subscription,a;u=u?[].concat(u):[],this._engine.clientExists(o,function(f){f||(s.error=e.Error.clientUnknown(o)),o||(s.error=e.Error.parameterMissing("clientId")),t.subscription||(s.error=e.Error.parameterMissing("subscription")),s.subscription=t.subscription||[];for(var l=0,c=u.length;l<c;l++){a=u[l];if(s.error)break;!n&&!e.Channel.isSubscribable(a)&&(s.error=e.Error.channelForbidden(a)),e.Channel.isValid(a)||(s.error=e.Error.channelInvalid(a));if(s.error)break;this._engine.unsubscribe(o,a)}s.successful=!s.error,r.call(i,s)},this)}}),e.extend(e.Server.prototype,e.Logging),e.extend(e.Server.prototype,e.Extensible),e.Server.Socket=e.Class({initialize:function(e,t,n){this._server=e,this._socket=t,this._request=n},send:function(t){this._server.pipeThroughExtensions("outgoing",t,this._request,function(t){this._socket&&this._socket.send(e.toJSON([t]))},this)},close:function(){this._socket&&this._socket.close(),delete this._socket}}),e.Transport.NodeLocal=e.extend(e.Class(e.Transport,{batching:!1,request:function(t){t=e.copyObject(t),this.endpoint.process(t,null,function(t){this._receive(e.copyObject(t))},this)}}),{isUsable:function(t,n,r,i){r.call(i,n instanceof e.Server)}}),e.Transport.register("in-process",e.Transport.NodeLocal),e.Transport.WebSocket=e.extend(e.Class(e.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(e,t){this.callback(function(){e.call(t,!0)}),this.errback(function(){e.call(t,!1)}),this.connect()},request:function(t){this._pending=this._pending||new e.Set;for(var n=0,r=t.length;n<r;n++)this._pending.add(t[n]);var i=new e.Promise;return this.callback(function(n){if(!n)return;n.send(e.toJSON(t)),e.Promise.fulfill(i,n)},this),this.connect(),{abort:function(){i.then(function(e){e.close()})}}},connect:function(){if(e.Transport.WebSocket._unloaded)return;this._state=this._state||this.UNCONNECTED;if(this._state!==this.UNCONNECTED)return;this._state=this.CONNECTING;var t=this._createSocket();if(!t)return this.setDeferredStatus("failed");var n=this;t.onopen=function(){t.headers&&n._storeCookies(t.headers["set-cookie"]),n._socket=t,n._state=n.CONNECTED,n._everConnected=!0,n._ping(),n.setDeferredStatus("succeeded",t)};var r=!1;t.onclose=t.onerror=function(){if(r)return;r=!0;var e=n._state===n.CONNECTED;t.onopen=t.onclose=t.onerror=t.onmessage=null,delete n._socket,n._state=n.UNCONNECTED,n.removeTimeout("ping"),n.setDeferredStatus("unknown");var i=n._pending?n._pending.toArray():[];delete n._pending,e?n._handleError(i,!0):n._everConnected?n._handleError(i):n.setDeferredStatus("failed")},t.onmessage=function(e){var t=JSON.parse(e.data);if(!t)return;t=[].concat(t);for(var r=0,i=t.length;r<i;r++){if(t[r].successful===undefined)continue;n._pending.remove(t[r])}n._receive(t)}},close:function(){if(!this._socket)return;this._socket.close()},_createSocket:function(){var t=e.Transport.WebSocket.getSocketUrl(this.endpoint),n=this._dispatcher.headers,r=this._dispatcher.wsExtensions,i=this._getCookies(),s=this._dispatcher.tls,o={extensions:r,headers:n,proxy:this._proxy,tls:s};i!==""&&(o.headers.Cookie=i);if(e.WebSocket)return new e.WebSocket.Client(t,[],o);if(e.ENV.MozWebSocket)return new MozWebSocket(t);if(e.ENV.WebSocket)return new WebSocket(t)},_ping:function(){if(!this._socket)return;this._socket.send("[]"),this.addTimeout("ping",this._dispatcher.timeout/2,this._ping,this)}}),{PROTOCOLS:{"http:":"ws:","https:":"wss:"},create:function(e,t){var n=e.transports.websocket=e.transports.websocket||{};return n[t.href]=n[t.href]||new this(e,t),n[t.href]},getSocketUrl:function(t){return t=e.copyObject(t),t.protocol=this.PROTOCOLS[t.protocol],e.URI.stringify(t)},isUsable:function(e,t,n,r){this.create(e,t).isUsable(n,r)}}),e.extend(e.Transport.WebSocket.prototype,e.Deferrable),e.Transport.register("websocket",e.Transport.WebSocket),e.Event&&e.ENV.onbeforeunload!==undefined&&e.Event.on(e.ENV,"beforeunload",function(){e.Transport.WebSocket._unloaded=!0}),e.Transport.NodeHttp=e.extend(e.Class(e.Transport,{initialize:function(){e.Transport.prototype.initialize.apply(this,arguments),this._endpointSecure=this.SECURE_PROTOCOLS.indexOf(this.endpoint.protocol)>=0,this._httpClient=this._endpointSecure?i:r;var t=this._proxy;if(!t.origin)return;this._proxyUri=a.parse(t.origin),this._proxySecure=this.SECURE_PROTOCOLS.indexOf(this._proxyUri.protocol)>=0;if(!this._endpointSecure){this._httpClient=this._proxySecure?i:r;return}var n=e.extend({proxy:{host:this._proxyUri.hostname,port:this._proxyUri.port||this.DEFAULT_PORTS[this._proxyUri.protocol],proxyAuth:this._proxyUri.auth,headers:e.extend({host:this.endpoint.host},t.headers)}},this._dispatcher.tls);this._proxySecure?(e.extend(n.proxy,t.tls),this._tunnel=c.httpsOverHttps(n)):this._tunnel=c.httpsOverHttp(n)},encode:function(t){return e.toJSON(t)},request:function(e){var t=new Buffer(this.encode(e),"utf8"),n=this._buildParams(t),r=this._httpClient.request(n),i=this;return r.on("response",function(t){i._handleResponse(e,t),i._storeCookies(t.headers["set-cookie"])}),r.on("error",function(t){i._handleError(e)}),r.end(t),r},_buildParams:function(t){var n=this.endpoint,r=this._proxyUri,i=this._tunnel?n:r||n,s={method:"POST",host:i.hostname,port:i.port||this.DEFAULT_PORTS[i.protocol],path:n.path,headers:e.extend({"Content-Length":t.length,"Content-Type":"application/json",Host:n.host},this._dispatcher.headers)},o=this._getCookies();return o!==""&&(s.headers.Cookie=o),this._tunnel?s.agent=this._tunnel:this._endpointSecure?e.extend(s,this._dispatcher.tls):r&&(s.path=this.endpoint.href,e.extend(s,this._proxy.tls),r.auth&&(s.headers["Proxy-Authorization"]=(new Buffer(r.auth,"utf8")).toString("base64"))),s},_handleResponse:function(e,t){var n=null,r="",i=this;t.setEncoding("utf8"),t.on("data",function(e){r+=e}),t.on("end",function(){try{n=JSON.parse(r)}catch(t){}n?i._receive(n):i._handleError(e)})}}),{isUsable:function(t,n,r,i){r.call(i,e.URI.isURI(n))}}),e.Transport.register("long-polling",e.Transport.NodeHttp);var t=require("crypto"),n=require("fs"),r=require("http"),i=require("https"),s=require("net"),o=require("path"),u=require("tls"),a=require("url"),f=require("querystring"),l=require("csprng"),c=require("tunnel-agent");e.WebSocket=require("faye-websocket"),e.EventSource=e.WebSocket.EventSource,e.Cookies=require("tough-cookie"),e.NodeAdapter=e.Class({DEFAULT_ENDPOINT:"/bayeux",SCRIPT_PATH:"faye-browser-min.js",TYPE_JSON:{"Content-Type":"application/json; charset=utf-8"},TYPE_SCRIPT:{"Content-Type":"text/javascript; charset=utf-8"},TYPE_TEXT:{"Content-Type":"text/plain; charset=utf-8"},VALID_JSONP_CALLBACK:/^[a-z_\$][a-z0-9_\$]*(\.[a-z_\$][a-z0-9_\$]*)*$/i,initialize:function(t){this._options=t||{},e.WebSocket.validateOptions(this._options,["engine","mount","ping","timeout","extensions","websocketExtensions"]),this._extensions=[],this._endpoint=this._options.mount||this.DEFAULT_ENDPOINT,this._endpointRe=new RegExp("^"+this._endpoint.replace(/\/$/,"")+"(/[^/]*)*(\\.[^\\.]+)?$"),this._server=new e.Server(this._options),this._static=new e.StaticServer(o.dirname(__filename)+"/../browser",/\.(?:js|map)$/),this._static.map(o.basename(this._endpoint)+".js",this.SCRIPT_PATH),this._static.map("client.js",this.SCRIPT_PATH);var n=this._options.extensions,r=this._options.websocketExtensions,i,s;if(n){n=[].concat(n);for(i=0,s=n.length;i<s;i++)this.addExtension(n[i])}if(r){r=[].concat(r);for(i=0,s=r.length;i<s;i++)this.addWebsocketExtension(r[i])}},listen:function(){throw new Error("The listen() method is deprecated - use the attach() method to bind Faye to an http.Server")},addExtension:function(e){return this._server.addExtension(e)},removeExtension:function(e){return this._server.removeExtension(e)},addWebsocketExtension:function(e){this._extensions.push(e)},close:function(){return this._server.close()},getClient:function(){return this._client=this._client||new e.Client(this._server)},attach:function(e){this._overrideListeners(e,"request","handle"),this._overrideListeners(e,"upgrade","handleUpgrade")},_overrideListeners:function(e,t,n){var r=e.listeners(t),i=this;e.removeAllListeners(t),e.on(t,function(e){if(i.check(e))return i[n].apply(i,arguments);for(var t=0,s=r.length;t<s;t++)r[t].apply(this,arguments)})},check:function(e){var t=a.parse(e.url,!0).pathname;return!!this._endpointRe.test(t)},handle:function(t,n){var r=a.parse(t.url,!0),i=t.method,s=this;t.originalUrl=t.url,t.on("error",function(e){s._returnError(n,e)}),n.on("error",function(e){s._returnError(null,e)});if(this._static.test(r.pathname))return this._static.call(t,n);if(i==="OPTIONS"||t.headers["access-control-request-method"]==="POST")return this._handleOptions(n);if(e.EventSource.isEventSource(t))return this.handleEventSource(t,n);if(i==="GET")return this._callWithParams(t,n,r.query);if(i==="POST")return this._concatStream(t,function(e){var r=(t.headers["content-type"]||"").split(";")[0],i=r==="application/json"?{message:e}:f.parse(e);t.body=e,this._callWithParams(t,n,i)},this);this._returnError(n,{message:"Unrecognized request type"})},_callWithParams:function(t,n,r){if(!r.message)return this._returnError(n,{message:"Received request with no message: "+this._formatRequest(t)});try{this.debug("Received message via HTTP "+t.method+": ?",r.message);var i=JSON.parse(r.message),s=r.jsonp||e.JSONP_CALLBACK,o=t.method==="GET",u=o?this.TYPE_SCRIPT:this.TYPE_JSON,a=e.extend({},u),f=t.headers.origin;if(!this.VALID_JSONP_CALLBACK.test(s))return this._returnError(n,{message:"Invalid JSON-P callback: "+s});f&&(a["Access-Control-Allow-Origin"]=f),a["Cache-Control"]="no-cache, no-store",a["X-Content-Type-Options"]="nosniff",this._server.process(i,t,function(t){var r=e.toJSON(t);o&&(r="/**/"+s+"("+this._jsonpEscape(r)+");",a["Content-Disposition"]="attachment; filename=f.txt"),a["Content-Length"]=(new Buffer(r,"utf8")).length.toString(),a.Connection="close",this.debug("HTTP response: ?",r),n.writeHead(200,a),n.end(r)},this)}catch(l){this._returnError(n,l)}},_jsonpEscape:function(e){return e.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},handleUpgrade:function(t,n,r){var i={extensions:this._extensions,ping:this._options.ping},s=new e.WebSocket(t,n,r,[],i),o=null,u=this;t.originalUrl=t.url,s.onmessage=function(n){try{u.debug("Received message via WebSocket["+s.version+"]: ?",n.data);var r=JSON.parse(n.data),i=e.clientIdFromMessages(r);o&&i&&i!==o&&u._server.closeSocket(o,!1),u._server.openSocket(i,s,t),i&&(o=i),u._server.process(r,t,function(t){s&&s.send(e.toJSON(t))})}catch(a){u.error(a.message+"\nBacktrace:\n"+a.stack)}},s.onclose=function(e){u._server.closeSocket(o),s=null}},handleEventSource:function(t,n){var r=new e.EventSource(t,n,{ping:this._options.ping}),i=r.url.split("/").pop(),s=this;this.debug("Opened EventSource connection for ?",i),this._server.openSocket(i,r,t),r.onclose=function(e){s._server.closeSocket(i),r=null}},_handleOptions:function(e){var t={"Access-Control-Allow-Credentials":"false","Access-Control-Allow-Headers":"Accept, Content-Type, Pragma, X-Requested-With","Access-Control-Allow-Methods":"POST, GET, PUT, DELETE, OPTIONS","Access-Control-Allow-Origin":"*","Access-Control-Max-Age":"86400"};e.writeHead(200,t),e.end("")},_concatStream:function(e,t,n){var r=[],i=0;e.on("data",function(e){r.push(e),i+=e.length}),e.on("end",function(){var e=new Buffer(i),s=0;for(var o=0,u=r.length;o<u;o++)r[o].copy(e,s),s+=r[o].length;t.call(n,e.toString("utf8"))})},_formatRequest:function(e){var t=e.method.toUpperCase(),n="curl -X "+t;return n+=" 'http://"+e.headers.host+e.url+"'",t==="POST"&&(n+=" -H 'Content-Type: "+e.headers["content-type"]+"'",n+=" -d '"+e.body+"'"),n},_returnError:function(e,t){var n=t.message;t.stack&&(n+="\nBacktrace:\n"+t.stack),this.error(n);if(!e)return;e.writeHead(400,this.TYPE_TEXT),e.end("Bad request")}});for(var h in e.Publisher)(function(t){e.NodeAdapter.prototype[t]=function(){return this._server._engine[t].apply(this._server._engine,arguments)}})(h);e.extend(e.NodeAdapter.prototype,e.Logging),e.StaticServer=e.Class({initialize:function(e,t){this._directory=e,this._pathRegex=t,this._pathMap={},this._index={}},map:function(e,t){this._pathMap[e]=t},test:function(e){return this._pathRegex.test(e)},call:function(r,i){var s=a.parse(r.url,!0).pathname,u=o.basename(s);u=this._pathMap[u]||u,this._index[u]=this._index[u]||{};var f=this._index[u],l=o.join(this._directory,u);try{f.content=f.content||n.readFileSync(l),f.digest=f.digest||t.createHash("sha1").update(f.content).digest("hex"),f.mtime=f.mtime||n.statSync(l).mtime}catch(c){return i.writeHead(404,{}),i.end()}var h=/\.js$/.test(s)?"TYPE_SCRIPT":"TYPE_JSON",p=r.headers["if-modified-since"],d={ETag:f.digest,"Last-Modified":f.mtime.toGMTString()};r.headers["if-none-match"]===f.digest?(i.writeHead(304,d),i.end()):p&&f.mtime<=new Date(p)?(i.writeHead(304,d),i.end()):(d["Content-Length"]=f.content.length,e.extend(d,e.NodeAdapter.prototype[h]),i.writeHead(200,d),i.end(f.content))}})})();