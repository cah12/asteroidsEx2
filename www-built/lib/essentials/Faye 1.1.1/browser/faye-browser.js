/*
Copyright Joyent, Inc. and other Node contributors. All rights reserved.
Permission is hereby granted, free of charge, to any person obtaining a copy of
this software and associated documentation files (the "Software"), to deal in
the Software without restriction, including without limitation the rights to
use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
of the Software, and to permit persons to whom the Software is furnished to do
so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
*/

(function(){"use strict";var Faye={VERSION:"1.1.1",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:["long-polling","cross-origin-long-polling","callback-polling","websocket","eventsource","in-process"],MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:typeof window!="undefined"?window:global,extend:function(e,t,n){if(!t)return e;for(var r in t){if(!t.hasOwnProperty(r))continue;if(e.hasOwnProperty(r)&&n===!1)continue;e[r]!==t[r]&&(e[r]=t[r])}return e},random:function(e){e=e||this.ID_LENGTH;var t=Math.ceil(e*Math.log(2)/Math.log(36)),n=csprng(e,36);while(n.length<t)n="0"+n;return n},validateOptions:function(e,t){for(var n in e)if(this.indexOf(t,n)<0)throw new Error("Unrecognized option: "+n)},clientIdFromMessages:function(e){var t=this.filter([].concat(e),function(e){return e.channel==="/meta/connect"});return t[0]&&t[0].clientId},copyObject:function(e){var t,n,r;if(e instanceof Array){t=[],n=e.length;while(n--)t[n]=Faye.copyObject(e[n]);return t}if(typeof e=="object"){t=e===null?null:{};for(r in e)t[r]=Faye.copyObject(e[r]);return t}return e},commonElement:function(e,t){for(var n=0,r=e.length;n<r;n++)if(this.indexOf(t,e[n])!==-1)return e[n];return null},indexOf:function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},map:function(e,t,n){if(e.map)return e.map(t,n);var r=[];if(e instanceof Array)for(var i=0,s=e.length;i<s;i++)r.push(t.call(n||null,e[i],i));else for(var o in e){if(!e.hasOwnProperty(o))continue;r.push(t.call(n||null,o,e[o]))}return r},filter:function(e,t,n){if(e.filter)return e.filter(t,n);var r=[];for(var i=0,s=e.length;i<s;i++)t.call(n||null,e[i],i)&&r.push(e[i]);return r},asyncEach:function(e,t,n,r){var i=e.length,s=-1,o=0,u=!1,a=function(){o-=1,s+=1;if(s===i)return n&&n.call(r);t(e[s],l)},f=function(){if(u)return;u=!0;while(o>0)a();u=!1},l=function(){o+=1,f()};l()},toJSON:function(e){return this.stringify?this.stringify(e,function(e,t){return this[e]instanceof Array?this[e]:t}):JSON.stringify(e)}};typeof module!="undefined"?module.exports=Faye:typeof window!="undefined"&&(window.Faye=Faye),Faye.Class=function(e,t){typeof e!="function"&&(t=e,e=Object);var n=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},r=function(){};return r.prototype=e.prototype,n.prototype=new r,Faye.extend(n.prototype,t),n},function(){function n(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<e.length;n++)if(t===e[n])return n;return-1}var e=Faye.EventEmitter=function(){},t=typeof Array.isArray=="function"?Array.isArray:function(e){return Object.prototype.toString.call(e)==="[object Array]"};e.prototype.emit=function(e){if(e==="error")if(!this._events||!this._events.error||t(this._events.error)&&!this._events.error.length)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var n=this._events[e];if(!n)return!1;if(typeof n=="function"){switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:var r=Array.prototype.slice.call(arguments,1);n.apply(this,r)}return!0}if(t(n)){var r=Array.prototype.slice.call(arguments,1),i=n.slice();for(var s=0,o=i.length;s<o;s++)i[s].apply(this,r);return!0}return!1},e.prototype.addListener=function(e,n){if("function"!=typeof n)throw new Error("addListener only takes instances of Function");return this._events||(this._events={}),this.emit("newListener",e,n),this._events[e]?t(this._events[e])?this._events[e].push(n):this._events[e]=[this._events[e],n]:this._events[e]=n,this},e.prototype.on=e.prototype.addListener,e.prototype.once=function(e,t){var n=this;return n.on(e,function r(){n.removeListener(e,r),t.apply(this,arguments)}),this},e.prototype.removeListener=function(e,r){if("function"!=typeof r)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[e])return this;var i=this._events[e];if(t(i)){var s=n(i,r);if(s<0)return this;i.splice(s,1),i.length==0&&delete this._events[e]}else this._events[e]===r&&delete this._events[e];return this},e.prototype.removeAllListeners=function(e){return arguments.length===0?(this._events={},this):(e&&this._events&&this._events[e]&&(this._events[e]=null),this)},e.prototype.listeners=function(e){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),t(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]}}(),Faye.Namespace=Faye.Class({initialize:function(){this._used={}},exists:function(e){return this._used.hasOwnProperty(e)},generate:function(){var e=Faye.random();while(this._used.hasOwnProperty(e))e=Faye.random();return this._used[e]=e},release:function(e){delete this._used[e]}}),function(){var e=setTimeout,t;typeof setImmediate=="function"?t=function(e){setImmediate(e)}:typeof process=="object"&&process.nextTick?t=function(e){process.nextTick(e)}:t=function(t){e(t,0)};var n=0,r=1,i=2,s=function(e){return e},o=function(e){throw e},u=function(e){this._state=n,this._onFulfilled=[],this._onRejected=[];if(typeof e!="function")return;var t=this;e(function(e){h(t,e)},function(e){d(t,e)})};u.prototype.then=function(e,t){var n=new u;return a(this,e,n),f(this,t,n),n};var a=function(e,t,i){typeof t!="function"&&(t=s);var o=function(e){l(t,e,i)};e._state===n?e._onFulfilled.push(o):e._state===r&&o(e._value)},f=function(e,t,r){typeof t!="function"&&(t=o);var s=function(e){l(t,e,r)};e._state===n?e._onRejected.push(s):e._state===i&&s(e._reason)},l=function(e,n,r){t(function(){c(e,n,r)})},c=function(e,t,n){var r;try{r=e(t)}catch(i){return d(n,i)}r===n?d(n,new TypeError("Recursive promise chain detected")):h(n,r)},h=u.fulfill=u.resolve=function(e,t){var n=!1,r,i;try{r=typeof t,i=t!==null&&(r==="function"||r==="object")&&t.then;if(typeof i!="function")return p(e,t);i.call(t,function(t){if(!(n^(n=!0)))return;h(e,t)},function(t){if(!(n^(n=!0)))return;d(e,t)})}catch(s){if(!(n^(n=!0)))return;d(e,s)}},p=function(e,t){if(e._state!==n)return;e._state=r,e._value=t,e._onRejected=[];var i=e._onFulfilled,s;while(s=i.shift())s(t)},d=u.reject=function(e,t){if(e._state!==n)return;e._state=i,e._reason=t,e._onFulfilled=[];var r=e._onRejected,s;while(s=r.shift())s(t)};u.all=function(e){return new u(function(t,n){var r=[],i=e.length,s;if(i===0)return t(r);for(s=0;s<i;s++)(function(e,s){u.fulfilled(e).then(function(e){r[s]=e,--i===0&&t(r)},n)})(e[s],s)})},u.defer=t,u.deferred=u.pending=function(){var e={};return e.promise=new u(function(t,n){e.fulfill=e.resolve=t,e.reject=n}),e},u.fulfilled=u.resolved=function(e){return new u(function(t,n){t(e)})},u.rejected=function(e){return new u(function(t,n){n(e)})},typeof Faye=="undefined"?module.exports=u:Faye.Promise=u}(),Faye.Set=Faye.Class({initialize:function(){this._index={}},add:function(e){var t=e.id!==undefined?e.id:e;return this._index.hasOwnProperty(t)?!1:(this._index[t]=e,!0)},forEach:function(e,t){for(var n in this._index)this._index.hasOwnProperty(n)&&e.call(t,this._index[n])},isEmpty:function(){for(var e in this._index)if(this._index.hasOwnProperty(e))return!1;return!0},member:function(e){for(var t in this._index)if(this._index[t]===e)return!0;return!1},remove:function(e){var t=e.id!==undefined?e.id:e,n=this._index[t];return delete this._index[t],n},toArray:function(){var e=[];return this.forEach(function(t){e.push(t)}),e}}),Faye.URI={isURI:function(e){return e&&e.protocol&&e.host&&e.path},isSameOrigin:function(e){var t=Faye.ENV.location;return e.protocol===t.protocol&&e.hostname===t.hostname&&e.port===t.port},parse:function(e){if(typeof e!="string")return e;var t={},n,r,i,s,o,u,a=function(n,r){e=e.replace(r,function(e){return t[n]=e,""}),t[n]=t[n]||""};a("protocol",/^[a-z]+\:/i),a("host",/^\/\/[^\/\?#]+/),!/^\//.test(e)&&!t.host&&(e=Faye.ENV.location.pathname.replace(/[^\/]*$/,"")+e),a("pathname",/^[^\?#]*/),a("search",/^\?[^#]*/),a("hash",/^#.*/),t.protocol=t.protocol||Faye.ENV.location.protocol,t.host?(t.host=t.host.substr(2),n=t.host.split(":"),t.hostname=n[0],t.port=n[1]||""):(t.host=Faye.ENV.location.host,t.hostname=Faye.ENV.location.hostname,t.port=Faye.ENV.location.port),t.pathname=t.pathname||"/",t.path=t.pathname+t.search,r=t.search.replace(/^\?/,""),i=r?r.split("&"):[],u={};for(s=0,o=i.length;s<o;s++)n=i[s].split("="),u[decodeURIComponent(n[0]||"")]=decodeURIComponent(n[1]||"");return t.query=u,t.href=this.stringify(t),t},stringify:function(e){var t=e.protocol+"//"+e.hostname;return e.port&&(t+=":"+e.port),t+=e.pathname+this.queryString(e.query)+(e.hash||""),t},queryString:function(e){var t=[];for(var n in e){if(!e.hasOwnProperty(n))continue;t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]))}return t.length===0?"":"?"+t.join("&")}},Faye.Error=Faye.Class({initialize:function(e,t,n){this.code=e,this.params=Array.prototype.slice.call(t),this.message=n},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),Faye.Error.parse=function(e){e=e||"";if(!Faye.Grammar.ERROR.test(e))return new this(null,[],e);var t=e.split(":"),n=parseInt(t[0]),r=t[1].split(","),e=t[2];return new this(n,r,e)},Faye.Error.versionMismatch=function(){return(new this(300,arguments,"Version mismatch")).toString()},Faye.Error.conntypeMismatch=function(){return(new this(301,arguments,"Connection types not supported")).toString()},Faye.Error.extMismatch=function(){return(new this(302,arguments,"Extension mismatch")).toString()},Faye.Error.badRequest=function(){return(new this(400,arguments,"Bad request")).toString()},Faye.Error.clientUnknown=function(){return(new this(401,arguments,"Unknown client")).toString()},Faye.Error.parameterMissing=function(){return(new this(402,arguments,"Missing required parameter")).toString()},Faye.Error.channelForbidden=function(){return(new this(403,arguments,"Forbidden channel")).toString()},Faye.Error.channelUnknown=function(){return(new this(404,arguments,"Unknown channel")).toString()},Faye.Error.channelInvalid=function(){return(new this(405,arguments,"Invalid channel")).toString()},Faye.Error.extUnknown=function(){return(new this(406,arguments,"Unknown extension")).toString()},Faye.Error.publishFailed=function(){return(new this(407,arguments,"Failed to publish")).toString()},Faye.Error.serverError=function(){return(new this(500,arguments,"Internal server error")).toString()},Faye.Deferrable={then:function(e,t){var n=this;return this._promise||(this._promise=new Faye.Promise(function(e,t){n._fulfill=e,n._reject=t})),arguments.length===0?this._promise:this._promise.then(e,t)},callback:function(e,t){return this.then(function(n){e.call(t,n)})},errback:function(e,t){return this.then(null,function(n){e.call(t,n)})},timeout:function(e,t){this.then();var n=this;this._timer=Faye.ENV.setTimeout(function(){n._reject(t)},e*1e3)},setDeferredStatus:function(e,t){this._timer&&Faye.ENV.clearTimeout(this._timer),this.then(),e==="succeeded"?this._fulfill(t):e==="failed"?this._reject(t):delete this._promise}},Faye.Publisher={countListeners:function(e){return this.listeners(e).length},bind:function(e,t,n){var r=Array.prototype.slice,i=function(){t.apply(n,r.call(arguments))};return this._listeners=this._listeners||[],this._listeners.push([e,t,n,i]),this.on(e,i)},unbind:function(e,t,n){this._listeners=this._listeners||[];var r=this._listeners.length,i;while(r--){i=this._listeners[r];if(i[0]!==e)continue;if(!(!t||i[1]===t&&i[2]===n))continue;this._listeners.splice(r,1),this.removeListener(e,i[3])}}},Faye.extend(Faye.Publisher,Faye.EventEmitter.prototype),Faye.Publisher.trigger=Faye.Publisher.emit,Faye.Timeouts={addTimeout:function(e,t,n,r){this._timeouts=this._timeouts||{};if(this._timeouts.hasOwnProperty(e))return;var i=this;this._timeouts[e]=Faye.ENV.setTimeout(function(){delete i._timeouts[e],n.call(r)},1e3*t)},removeTimeout:function(e){this._timeouts=this._timeouts||{};var t=this._timeouts[e];if(!t)return;Faye.ENV.clearTimeout(t),delete this._timeouts[e]},removeAllTimeouts:function(){this._timeouts=this._timeouts||{};for(var e in this._timeouts)this.removeTimeout(e)}},Faye.Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function(e,t){if(!Faye.logger)return;var n=Array.prototype.slice.apply(e),r="[Faye",i=this.className,s=n.shift().replace(/\?/g,function(){try{return Faye.toJSON(n.shift())}catch(e){return"[Object]"}});for(var o in Faye){if(i)continue;if(typeof Faye[o]!="function")continue;this instanceof Faye[o]&&(i=o)}i&&(r+="."+i),r+="] ",typeof Faye.logger[t]=="function"?Faye.logger[t](r+s):typeof Faye.logger=="function"&&Faye.logger(r+s)}},function(){for(var e in Faye.Logging.LOG_LEVELS)(function(e){Faye.Logging[e]=function(){this.writeLog(arguments,e)}})(e)}(),Faye.Grammar={CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/},Faye.Extensible={addExtension:function(e){this._extensions=this._extensions||[],this._extensions.push(e),e.added&&e.added(this)},removeExtension:function(e){if(!this._extensions)return;var t=this._extensions.length;while(t--){if(this._extensions[t]!==e)continue;this._extensions.splice(t,1),e.removed&&e.removed(this)}},pipeThroughExtensions:function(e,t,n,r,i){this.debug("Passing through ? extensions: ?",e,t);if(!this._extensions)return r.call(i,t);var s=this._extensions.slice(),o=function(t){if(!t)return r.call(i,t);var u=s.shift();if(!u)return r.call(i,t);var a=u[e];if(!a)return o(t);a.length>=3?u[e](t,n,o):u[e](t,o)};o(t)}},Faye.extend(Faye.Extensible,Faye.Logging),Faye.Channel=Faye.Class({initialize:function(e){this.id=this.name=e},push:function(e){this.trigger("message",e)},isUnused:function(){return this.countListeners("message")===0}}),Faye.extend(Faye.Channel.prototype,Faye.Publisher),Faye.extend(Faye.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(e){var t=this.parse(e),n=["/**",e],r=t.slice();r[r.length-1]="*",n.push(this.unparse(r));for(var i=1,s=t.length;i<s;i++)r=t.slice(0,i),r.push("**"),n.push(this.unparse(r));return n},isValid:function(e){return Faye.Grammar.CHANNEL_NAME.test(e)||Faye.Grammar.CHANNEL_PATTERN.test(e)},parse:function(e){return this.isValid(e)?e.split("/").slice(1):null},unparse:function(e){return"/"+e.join("/")},isMeta:function(e){var t=this.parse(e);return t?t[0]===this.META:null},isService:function(e){var t=this.parse(e);return t?t[0]===this.SERVICE:null},isSubscribable:function(e){return this.isValid(e)?!this.isMeta(e)&&!this.isService(e):null},Set:Faye.Class({initialize:function(){this._channels={}},getKeys:function(){var e=[];for(var t in this._channels)e.push(t);return e},remove:function(e){delete this._channels[e]},hasSubscription:function(e){return this._channels.hasOwnProperty(e)},subscribe:function(e,t,n){var r;for(var i=0,s=e.length;i<s;i++){r=e[i];var o=this._channels[r]=this._channels[r]||new Faye.Channel(r);t&&o.bind("message",t,n)}},unsubscribe:function(e,t,n){var r=this._channels[e];return r?(r.unbind("message",t,n),r.isUnused()?(this.remove(e),!0):!1):!1},distributeMessage:function(e){var t=Faye.Channel.expand(e.channel);for(var n=0,r=t.length;n<r;n++){var i=this._channels[t[n]];i&&i.trigger("message",e.data)}}})}),Faye.Publication=Faye.Class(Faye.Deferrable),Faye.Subscription=Faye.Class({initialize:function(e,t,n,r){this._client=e,this._channels=t,this._callback=n,this._context=r,this._cancelled=!1},cancel:function(){if(this._cancelled)return;this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0},unsubscribe:function(){this.cancel()}}),Faye.extend(Faye.Subscription.prototype,Faye.Deferrable),Faye.Client=Faye.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(e,t){this.info("New client created for ?",e),t=t||{},Faye.validateOptions(t,["interval","timeout","endpoints","proxy","retry","scheduler","websocketExtensions","tls","ca"]),this._endpoint=e||this.DEFAULT_ENDPOINT,this._channels=new Faye.Channel.Set,this._dispatcher=new Faye.Dispatcher(this,this._endpoint,t),this._messageId=0,this._state=this.UNCONNECTED,this._responseCallbacks={},this._advice={reconnect:this.RETRY,interval:1e3*(t.interval||this.INTERVAL),timeout:1e3*(t.timeout||this.CONNECTION_TIMEOUT)},this._dispatcher.timeout=this._advice.timeout/1e3,this._dispatcher.bind("message",this._receiveMessage,this),Faye.Event&&Faye.ENV.onbeforeunload!==undefined&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.indexOf(this._dispatcher._disabled,"autodisconnect")<0&&this.disconnect()},this)},addWebsocketExtension:function(e){return this._dispatcher.addWebsocketExtension(e)},disable:function(e){return this._dispatcher.disable(e)},setHeader:function(e,t){return this._dispatcher.setHeader(e,t)},handshake:function(e,t){if(this._advice.reconnect===this.NONE)return;if(this._state!==this.UNCONNECTED)return;this._state=this.CONNECTING;var n=this;this.info("Initiating handshake with ?",Faye.URI.stringify(this._endpoint)),this._dispatcher.selectTransport(Faye.MANDATORY_CONNECTION_TYPES),this._sendMessage({channel:Faye.Channel.HANDSHAKE,version:Faye.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},function(r){r.successful?(this._state=this.CONNECTED,this._dispatcher.clientId=r.clientId,this._dispatcher.selectTransport(r.supportedConnectionTypes),this.info("Handshake successful: ?",this._dispatcher.clientId),this.subscribe(this._channels.getKeys(),!0),e&&Faye.Promise.defer(function(){e.call(t)})):(this.info("Handshake unsuccessful"),Faye.ENV.setTimeout(function(){n.handshake(e,t)},this._dispatcher.retry*1e3),this._state=this.UNCONNECTED)},this)},connect:function(e,t){if(this._advice.reconnect===this.NONE)return;if(this._state===this.DISCONNECTED)return;if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(e,t)},this);this.callback(e,t);if(this._state!==this.CONNECTED)return;this.info("Calling deferred actions for ?",this._dispatcher.clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("unknown");if(this._connectRequest)return;this._connectRequest=!0,this.info("Initiating connection for ?",this._dispatcher.clientId),this._sendMessage({channel:Faye.Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this)},disconnect:function(){if(this._state!==this.CONNECTED)return;this._state=this.DISCONNECTED,this.info("Disconnecting ?",this._dispatcher.clientId);var e=new Faye.Publication;return this._sendMessage({channel:Faye.Channel.DISCONNECT,clientId:this._dispatcher.clientId},{},function(t){t.successful?(this._dispatcher.close(),e.setDeferredStatus("succeeded")):e.setDeferredStatus("failed",Faye.Error.parse(t.error))},this),this.info("Clearing channel listeners for ?",this._dispatcher.clientId),this._channels=new Faye.Channel.Set,e},subscribe:function(e,t,n){if(e instanceof Array)return Faye.map(e,function(e){return this.subscribe(e,t,n)},this);var r=new Faye.Subscription(this,e,t,n),i=t===!0,s=this._channels.hasSubscription(e);return s&&!i?(this._channels.subscribe([e],t,n),r.setDeferredStatus("succeeded"),r):(this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._dispatcher.clientId,e),i||this._channels.subscribe([e],t,n),this._sendMessage({channel:Faye.Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:e},{},function(i){if(!i.successful)return r.setDeferredStatus("failed",Faye.Error.parse(i.error)),this._channels.unsubscribe(e,t,n);var s=[].concat(i.subscription);this.info("Subscription acknowledged for ? to ?",this._dispatcher.clientId,s),r.setDeferredStatus("succeeded")},this)},this),r)},unsubscribe:function(e,t,n){if(e instanceof Array)return Faye.map(e,function(e){return this.unsubscribe(e,t,n)},this);var r=this._channels.unsubscribe(e,t,n);if(!r)return;this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._dispatcher.clientId,e),this._sendMessage({channel:Faye.Channel.UNSUBSCRIBE,clientId:this._dispatcher.clientId,subscription:e},{},function(e){if(!e.successful)return;var t=[].concat(e.subscription);this.info("Unsubscription acknowledged for ? from ?",this._dispatcher.clientId,t)},this)},this)},publish:function(e,t,n){Faye.validateOptions(n||{},["attempts","deadline"]);var r=new Faye.Publication;return this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._dispatcher.clientId,e,t),this._sendMessage({channel:e,data:t,clientId:this._dispatcher.clientId},n,function(e){e.successful?r.setDeferredStatus("succeeded"):r.setDeferredStatus("failed",Faye.Error.parse(e.error))},this)},this),r},_sendMessage:function(e,t,n,r){e.id=this._generateMessageId();var i=this._advice.timeout?1.2*this._advice.timeout/1e3:1.2*this._dispatcher.retry;this.pipeThroughExtensions("outgoing",e,null,function(e){if(!e)return;n&&(this._responseCallbacks[e.id]=[n,r]),this._dispatcher.sendMessage(e,i,t||{})},this)},_generateMessageId:function(){return this._messageId+=1,this._messageId>=Math.pow(2,32)&&(this._messageId=0),this._messageId.toString(36)},_receiveMessage:function(e){var t=e.id,n;e.successful!==undefined&&(n=this._responseCallbacks[t],delete this._responseCallbacks[t]),this.pipeThroughExtensions("incoming",e,null,function(e){if(!e)return;e.advice&&this._handleAdvice(e.advice),this._deliverMessage(e),n&&n[0].call(n[1],e)},this)},_handleAdvice:function(e){Faye.extend(this._advice,e),this._dispatcher.timeout=this._advice.timeout/1e3,this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=this.UNCONNECTED,this._dispatcher.clientId=null,this._cycleConnection())},_deliverMessage:function(e){if(!e.channel||e.data===undefined)return;this.info("Client ? calling listeners for ? with ?",this._dispatcher.clientId,e.channel,e.data),this._channels.distributeMessage(e)},_cycleConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._dispatcher.clientId));var e=this;Faye.ENV.setTimeout(function(){e.connect()},this._advice.interval)}}),Faye.extend(Faye.Client.prototype,Faye.Deferrable),Faye.extend(Faye.Client.prototype,Faye.Publisher),Faye.extend(Faye.Client.prototype,Faye.Logging),Faye.extend(Faye.Client.prototype,Faye.Extensible),Faye.Dispatcher=Faye.Class({MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,DOWN:2,initialize:function(e,t,n){this._client=e,this.endpoint=Faye.URI.parse(t),this._alternates=n.endpoints||{},this.cookies=Faye.Cookies&&new Faye.Cookies.CookieJar,this._disabled=[],this._envelopes={},this.headers={},this.retry=n.retry||this.DEFAULT_RETRY,this._scheduler=n.scheduler||Faye.Scheduler,this._state=0,this.transports={},this.wsExtensions=[],this.proxy=n.proxy||{},typeof this._proxy=="string"&&(this._proxy={origin:this._proxy});var r=n.websocketExtensions;if(r){r=[].concat(r);for(var i=0,s=r.length;i<s;i++)this.addWebsocketExtension(r[i])}this.tls=n.tls||{},this.tls.ca=this.tls.ca||n.ca;for(var o in this._alternates)this._alternates[o]=Faye.URI.parse(this._alternates[o]);this.maxRequestSize=this.MAX_REQUEST_SIZE},endpointFor:function(e){return this._alternates[e]||this.endpoint},addWebsocketExtension:function(e){this.wsExtensions.push(e)},disable:function(e){this._disabled.push(e)},setHeader:function(e,t){this.headers[e]=t},close:function(){var e=this._transport;delete this._transport,e&&e.close()},getConnectionTypes:function(){return Faye.Transport.getConnectionTypes()},selectTransport:function(e){Faye.Transport.get(this,e,this._disabled,function(e){this.debug("Selected ? transport for ?",e.connectionType,Faye.URI.stringify(e.endpoint));if(e===this._transport)return;this._transport&&this._transport.close(),this._transport=e,this.connectionType=e.connectionType},this)},sendMessage:function(e,t,n){n=n||{};var r=e.id,i=n.attempts,s=n.deadline&&(new Date).getTime()+n.deadline*1e3,o=this._envelopes[r],u;o||(u=new this._scheduler(e,{timeout:t,interval:this.retry,attempts:i,deadline:s}),o=this._envelopes[r]={message:e,scheduler:u}),this._sendEnvelope(o)},_sendEnvelope:function(e){if(!this._transport)return;if(e.request||e.timer)return;var t=e.message,n=e.scheduler,r=this;if(!n.isDeliverable()){n.abort(),delete this._envelopes[t.id];return}e.timer=Faye.ENV.setTimeout(function(){r.handleError(t)},n.getTimeout()*1e3),n.send(),e.request=this._transport.sendMessage(t)},handleResponse:function(e){var t=this._envelopes[e.id];e.successful!==undefined&&t&&(t.scheduler.succeed(),delete this._envelopes[e.id],Faye.ENV.clearTimeout(t.timer)),this.trigger("message",e);if(this._state===this.UP)return;this._state=this.UP,this._client.trigger("transport:up")},handleError:function(e,t){var n=this._envelopes[e.id],r=n&&n.request,i=this;if(!r)return;r.then(function(e){e&&e.abort&&e.abort()});var s=n.scheduler;s.fail(),Faye.ENV.clearTimeout(n.timer),n.request=n.timer=null,t?this._sendEnvelope(n):n.timer=Faye.ENV.setTimeout(function(){n.timer=null,i._sendEnvelope(n)},s.getInterval()*1e3);if(this._state===this.DOWN)return;this._state=this.DOWN,this._client.trigger("transport:down")}}),Faye.extend(Faye.Dispatcher.prototype,Faye.Publisher),Faye.extend(Faye.Dispatcher.prototype,Faye.Logging),Faye.Scheduler=function(e,t){this.message=e,this.options=t,this.attempts=0},Faye.extend(Faye.Scheduler.prototype,{getTimeout:function(){return this.options.timeout},getInterval:function(){return this.options.interval},isDeliverable:function(){var e=this.options.attempts,t=this.attempts,n=this.options.deadline,r=(new Date).getTime();return e!==undefined&&t>=e?!1:n!==undefined&&r>n?!1:!0},send:function(){this.attempts+=1},succeed:function(){},fail:function(){},abort:function(){}}),Faye.Transport=Faye.extend(Faye.Class({DEFAULT_PORTS:{"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS:["https:","wss:"],MAX_DELAY:0,batching:!0,initialize:function(e,t){this._dispatcher=e,this.endpoint=t,this._outbox=[],this._proxy=Faye.extend({},this._dispatcher.proxy),!this._proxy.origin&&Faye.NodeAdapter&&(this._proxy.origin=Faye.indexOf(this.SECURE_PROTOCOLS,this.endpoint.protocol)>=0?process.env.HTTPS_PROXY||process.env.https_proxy:process.env.HTTP_PROXY||process.env.http_proxy)},close:function(){},encode:function(e){return""},sendMessage:function(e){return this.debug("Client ? sending message to ?: ?",this._dispatcher.clientId,Faye.URI.stringify(this.endpoint),e),this.batching?(this._outbox.push(e),this._flushLargeBatch(),this._promise=this._promise||new Faye.Promise,e.channel===Faye.Channel.HANDSHAKE?(this.addTimeout("publish",.01,this._flush,this),this._promise):(e.channel===Faye.Channel.CONNECT&&(this._connectMessage=e),this.addTimeout("publish",this.MAX_DELAY,this._flush,this),this._promise)):Faye.Promise.fulfilled(this.request([e]))},_flush:function(){this.removeTimeout("publish"),this._outbox.length>1&&this._connectMessage&&(this._connectMessage.advice={timeout:0}),Faye.Promise.fulfill(this._promise,this.request(this._outbox)),delete this._promise,this._connectMessage=null,this._outbox=[]},_flushLargeBatch:function(){var e=this.encode(this._outbox);if(e.length<this._dispatcher.maxRequestSize)return;var t=this._outbox.pop();this._flush(),t&&this._outbox.push(t)},_receive:function(e){if(!e)return;e=[].concat(e),this.debug("Client ? received from ? via ?: ?",this._dispatcher.clientId,Faye.URI.stringify(this.endpoint),this.connectionType,e);for(var t=0,n=e.length;t<n;t++)this._dispatcher.handleResponse(e[t])},_handleError:function(e,t){e=[].concat(e),this.debug("Client ? failed to send to ? via ?: ?",this._dispatcher.clientId,Faye.URI.stringify(this.endpoint),this.connectionType,e);for(var n=0,r=e.length;n<r;n++)this._dispatcher.handleError(e[n])},_getCookies:function(){var e=this._dispatcher.cookies,t=Faye.URI.stringify(this.endpoint);return e?Faye.map(e.getCookiesSync(t),function(e){return e.cookieString()}).join("; "):""},_storeCookies:function(e){var t=this._dispatcher.cookies,n=Faye.URI.stringify(this.endpoint),r;if(!e||!t)return;e=[].concat(e);for(var i=0,s=e.length;i<s;i++)r=Faye.Cookies.Cookie.parse(e[i]),t.setCookieSync(r,n)}}),{get:function(e,t,n,r,i){var s=e.endpoint;Faye.asyncEach(this._transports,function(s,o){var u=s[0],a=s[1],f=e.endpointFor(u);if(Faye.indexOf(n,u)>=0)return o();if(Faye.indexOf(t,u)<0)return a.isUsable(e,f,function(){}),o();a.isUsable(e,f,function(t){if(!t)return o();var n=a.hasOwnProperty("create")?a.create(e,f):new a(e,f);r.call(i,n)})},function(){throw new Error("Could not find a usable connection type for "+Faye.URI.stringify(s))})},register:function(e,t){this._transports.push([e,t]),t.prototype.connectionType=e},getConnectionTypes:function(){return Faye.map(this._transports,function(e){return e[0]})},_transports:[]}),Faye.extend(Faye.Transport.prototype,Faye.Logging),Faye.extend(Faye.Transport.prototype,Faye.Timeouts),Faye.Event={_registry:[],on:function(e,t,n,r){var i=function(){n.call(r)};e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i),this._registry.push({_element:e,_type:t,_callback:n,_context:r,_handler:i})},detach:function(e,t,n,r){var i=this._registry.length,s;while(i--){s=this._registry[i];if(e&&e!==s._element||t&&t!==s._type||n&&n!==s._callback||r&&r!==s._context)continue;s._element.removeEventListener?s._element.removeEventListener(s._type,s._handler,!1):s._element.detachEvent("on"+s._type,s._handler),this._registry.splice(i,1),s=null}}},Faye.ENV.onunload!==undefined&&Faye.Event.on(Faye.ENV,"unload",Faye.Event.detach,Faye.Event),typeof JSON!="object"&&(JSON={}),function(){function f(e){return e<10?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return typeof t=="string"?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,r,i,s,o=gap,u,a=t[e];a&&typeof a=="object"&&typeof a.toJSON=="function"&&(a=a.toJSON(e)),typeof rep=="function"&&(a=rep.call(t,e,a));switch(typeof a){case"string":return quote(a);case"number":return isFinite(a)?String(a):"null";case"boolean":case"null":return String(a);case"object":if(!a)return"null";gap+=indent,u=[];if(Object.prototype.toString.apply(a)==="[object Array]"){s=a.length;for(n=0;n<s;n+=1)u[n]=str(n,a)||"null";return i=u.length===0?"[]":gap?"[\n"+gap+u.join(",\n"+gap)+"\n"+o+"]":"["+u.join(",")+"]",gap=o,i}if(rep&&typeof rep=="object"){s=rep.length;for(n=0;n<s;n+=1)typeof rep[n]=="string"&&(r=rep[n],i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i))}else for(r in a)Object.prototype.hasOwnProperty.call(a,r)&&(i=str(r,a),i&&u.push(quote(r)+(gap?": ":":")+i));return i=u.length===0?"{}":gap?"{\n"+gap+u.join(",\n"+gap)+"\n"+o+"}":"{"+u.join(",")+"}",gap=o,i}}typeof Date.prototype.toJSON!="function"&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;Faye.stringify=function(e,t,n){var r;gap="",indent="";if(typeof n=="number")for(r=0;r<n;r+=1)indent+=" ";else typeof n=="string"&&(indent=n);rep=t;if(!t||typeof t=="function"||typeof t=="object"&&typeof t.length=="number")return str("",{"":e});throw new Error("JSON.stringify")},typeof JSON.stringify!="function"&&(JSON.stringify=Faye.stringify),typeof JSON.parse!="function"&&(JSON.parse=function(text,reviver){function walk(e,t){var n,r,i=e[t];if(i&&typeof i=="object")for(n in i)Object.prototype.hasOwnProperty.call(i,n)&&(r=walk(i,n),r!==undefined?i[n]=r:delete i[n]);return reviver.call(e,t,i)}var j;text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),typeof reviver=="function"?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),Faye.Transport.WebSocket=Faye.extend(Faye.Class(Faye.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(e,t){this.callback(function(){e.call(t,!0)}),this.errback(function(){e.call(t,!1)}),this.connect()},request:function(e){this._pending=this._pending||new Faye.Set;for(var t=0,n=e.length;t<n;t++)this._pending.add(e[t]);var r=new Faye.Promise;return this.callback(function(t){if(!t)return;t.send(Faye.toJSON(e)),Faye.Promise.fulfill(r,t)},this),this.connect(),{abort:function(){r.then(function(e){e.close()})}}},connect:function(){if(Faye.Transport.WebSocket._unloaded)return;this._state=this._state||this.UNCONNECTED;if(this._state!==this.UNCONNECTED)return;this._state=this.CONNECTING;var e=this._createSocket();if(!e)return this.setDeferredStatus("failed");var t=this;e.onopen=function(){e.headers&&t._storeCookies(e.headers["set-cookie"]),t._socket=e,t._state=t.CONNECTED,t._everConnected=!0,t._ping(),t.setDeferredStatus("succeeded",e)};var n=!1;e.onclose=e.onerror=function(){if(n)return;n=!0;var r=t._state===t.CONNECTED;e.onopen=e.onclose=e.onerror=e.onmessage=null,delete t._socket,t._state=t.UNCONNECTED,t.removeTimeout("ping"),t.setDeferredStatus("unknown");var i=t._pending?t._pending.toArray():[];delete t._pending,r?t._handleError(i,!0):t._everConnected?t._handleError(i):t.setDeferredStatus("failed")},e.onmessage=function(e){var n=JSON.parse(e.data);if(!n)return;n=[].concat(n);for(var r=0,i=n.length;r<i;r++){if(n[r].successful===undefined)continue;t._pending.remove(n[r])}t._receive(n)}},close:function(){if(!this._socket)return;this._socket.close()},_createSocket:function(){var e=Faye.Transport.WebSocket.getSocketUrl(this.endpoint),t=this._dispatcher.headers,n=this._dispatcher.wsExtensions,r=this._getCookies(),i=this._dispatcher.tls,s={extensions:n,headers:t,proxy:this._proxy,tls:i};r!==""&&(s.headers.Cookie=r);if(Faye.WebSocket)return new Faye.WebSocket.Client(e,[],s);if(Faye.ENV.MozWebSocket)return new MozWebSocket(e);if(Faye.ENV.WebSocket)return new WebSocket(e)},_ping:function(){if(!this._socket)return;this._socket.send("[]"),this.addTimeout("ping",this._dispatcher.timeout/2,this._ping,this)}}),{PROTOCOLS:{"http:":"ws:","https:":"wss:"},create:function(e,t){var n=e.transports.websocket=e.transports.websocket||{};return n[t.href]=n[t.href]||new this(e,t),n[t.href]},getSocketUrl:function(e){return e=Faye.copyObject(e),e.protocol=this.PROTOCOLS[e.protocol],Faye.URI.stringify(e)},isUsable:function(e,t,n,r){this.create(e,t).isUsable(n,r)}}),Faye.extend(Faye.Transport.WebSocket.prototype,Faye.Deferrable),Faye.Transport.register("websocket",Faye.Transport.WebSocket),Faye.Event&&Faye.ENV.onbeforeunload!==undefined&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.Transport.WebSocket._unloaded=!0}),Faye.Transport.EventSource=Faye.extend(Faye.Class(Faye.Transport,{initialize:function(e,t){Faye.Transport.prototype.initialize.call(this,e,t);if(!Faye.ENV.EventSource)return this.setDeferredStatus("failed");this._xhr=new Faye.Transport.XHR(e,t),t=Faye.copyObject(t),t.pathname+="/"+e.clientId;var n=new EventSource(Faye.URI.stringify(t)),r=this;n.onopen=function(){r._everConnected=!0,r.setDeferredStatus("succeeded")},n.onerror=function(){r._everConnected?r._handleError([]):(r.setDeferredStatus("failed"),n.close())},n.onmessage=function(e){r._receive(JSON.parse(e.data))},this._socket=n},close:function(){if(!this._socket)return;this._socket.onopen=this._socket.onerror=this._socket.onmessage=null,this._socket.close(),delete this._socket},isUsable:function(e,t){this.callback(function(){e.call(t,!0)}),this.errback(function(){e.call(t,!1)})},encode:function(e){return this._xhr.encode(e)},request:function(e){return this._xhr.request(e)}}),{isUsable:function(e,t,n,r){var i=e.clientId;if(!i)return n.call(r,!1);Faye.Transport.XHR.isUsable(e,t,function(i){if(!i)return n.call(r,!1);this.create(e,t).isUsable(n,r)},this)},create:function(e,t){var n=e.transports.eventsource=e.transports.eventsource||{},r=e.clientId,i=Faye.copyObject(t);return i.pathname+="/"+(r||""),i=Faye.URI.stringify(i),n[i]=n[i]||new this(e,t),n[i]}}),Faye.extend(Faye.Transport.EventSource.prototype,Faye.Deferrable),Faye.Transport.register("eventsource",Faye.Transport.EventSource),Faye.Transport.XHR=Faye.extend(Faye.Class(Faye.Transport,{encode:function(e){return Faye.toJSON(e)},request:function(e){var t=this.endpoint.href,n=Faye.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest,r=this;n.open("POST",t,!0),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Pragma","no-cache"),n.setRequestHeader("X-Requested-With","XMLHttpRequest");var i=this._dispatcher.headers;for(var s in i){if(!i.hasOwnProperty(s))continue;n.setRequestHeader(s,i[s])}var o=function(){n.abort()};return Faye.ENV.onbeforeunload!==undefined&&Faye.Event.on(Faye.ENV,"beforeunload",o),n.onreadystatechange=function(){if(!n||n.readyState!==4)return;var t=null,i=n.status,s=n.responseText,u=i>=200&&i<300||i===304||i===1223;Faye.ENV.onbeforeunload!==undefined&&Faye.Event.detach(Faye.ENV,"beforeunload",o),n.onreadystatechange=function(){},n=null;if(!u)return r._handleError(e);try{t=JSON.parse(s)}catch(a){}t?r._receive(t):r._handleError(e)},n.send(this.encode(e)),n}}),{isUsable:function(e,t,n,r){n.call(r,Faye.URI.isSameOrigin(t))}}),Faye.Transport.register("long-polling",Faye.Transport.XHR),Faye.Transport.CORS=Faye.extend(Faye.Class(Faye.Transport,{encode:function(e){return"message="+encodeURIComponent(Faye.toJSON(e))},request:function(e){var t=Faye.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,n=new t,r=this._dispatcher.headers,i=this,s;n.open("POST",Faye.URI.stringify(this.endpoint),!0);if(n.setRequestHeader){n.setRequestHeader("Pragma","no-cache");for(s in r){if(!r.hasOwnProperty(s))continue;n.setRequestHeader(s,r[s])}}var o=function(){if(!n)return!1;n.onload=n.onerror=n.ontimeout=n.onprogress=null,n=null};return n.onload=function(){var t=null;try{t=JSON.parse(n.responseText)}catch(r){}o(),t?i._receive(t):i._handleError(e)},n.onerror=n.ontimeout=function(){o(),i._handleError(e)},n.onprogress=function(){},n.send(this.encode(e)),n}}),{isUsable:function(e,t,n,r){if(Faye.URI.isSameOrigin(t))return n.call(r,!1);if(Faye.ENV.XDomainRequest)return n.call(r,t.protocol===Faye.ENV.location.protocol);if(Faye.ENV.XMLHttpRequest){var i=new Faye.ENV.XMLHttpRequest;return n.call(r,i.withCredentials!==undefined)}return n.call(r,!1)}}),Faye.Transport.register("cross-origin-long-polling",Faye.Transport.CORS),Faye.Transport.JSONP=Faye.extend(Faye.Class(Faye.Transport,{encode:function(e){var t=Faye.copyObject(this.endpoint);return t.query.message=Faye.toJSON(e),t.query.jsonp="__jsonp"+Faye.Transport.JSONP._cbCount+"__",Faye.URI.stringify(t)},request:function(e){var t=document.getElementsByTagName("head")[0],n=document.createElement("script"),r=Faye.Transport.JSONP.getCallbackName(),i=Faye.copyObject(this.endpoint),s=this;i.query.message=Faye.toJSON(e),i.query.jsonp=r;var o=function(){if(!Faye.ENV[r])return!1;Faye.ENV[r]=undefined;try{delete Faye.ENV[r]}catch(e){}n.parentNode.removeChild(n)};return Faye.ENV[r]=function(e){o(),s._receive(e)},n.type="text/javascript",n.src=Faye.URI.stringify(i),t.appendChild(n),n.onerror=function(){o(),s._handleError(e)},{abort:o}}}),{_cbCount:0,getCallbackName:function(){return this._cbCount+=1,"__jsonp"+this._cbCount+"__"},isUsable:function(e,t,n,r){n.call(r,!0)}}),Faye.Transport.register("callback-polling",Faye.Transport.JSONP)})();