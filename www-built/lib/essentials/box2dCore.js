define(["underscore","Box2d"],function(e){var t={b2Vec2:Box2D.Common.Math.b2Vec2,b2BodyDef:Box2D.Dynamics.b2BodyDef,b2Body:Box2D.Dynamics.b2Body,b2FixtureDef:Box2D.Dynamics.b2FixtureDef,b2Fixture:Box2D.Dynamics.b2Fixture,b2World:Box2D.Dynamics.b2World,b2MassData:Box2D.Collision.Shapes.b2MassData,b2PolygonShape:Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape:Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw:Box2D.Dynamics.b2DebugDraw},n=window.Physics=function(n,r){var i=this,s=new t.b2Vec2(0,1);this.world=new t.b2World(s,!0),this.element=n,this.context=n.getContext("2d"),this.scale=r||30,this.dtRemaining=0,this.stepAmount=1/60,this.dragNDropCalled=!1,this.running=!0,this.screenboundaryThickness=0;var o=[];this.storeBodyForDestruction=function(e){o.push(e.body)},this.destroyBodies=function(){e.each(o,function(e){i.world.DestroyBody(e)}),o=[]}};n.prototype.destroyBody=function(e){this.storeBodyForDestruction(e)},n.prototype.screenBoundaries=function(e){var e=e||{},t=e.color||"transparent",n=this.screenboundaryThickness=e.wallThickness||7.5,i=this.element.width,s=this.element.height;new r(this,{type:"static",x:2*n/this.scale*.5,y:s/this.scale*.5,height:s/this.scale,width:2*n/this.scale,color:t,id:"boundary"}),new r(this,{type:"static",x:(i-n)/this.scale,y:s/this.scale*.5,height:s/this.scale,width:2*n/this.scale,color:t,id:"boundary"}),new r(this,{type:"static",x:i/this.scale*.5,y:2*n/this.scale*.5,height:2*n/this.scale,width:i/this.scale,color:t,id:"boundary"}),new r(this,{type:"static",x:i/this.scale*.5,y:(s-n)/this.scale,height:2*n/this.scale,width:i/this.scale,color:t,id:"boundary"})},n.prototype.animate=function(){var e=this,t=(new Date).getTime(),n=function(e){return window.requestAnimationFrame(e)||window.webkitRequestAnimationFrame(e)||window.mozRequestAnimationFrame(e)||function(e){window.setTimeout(e,1e3/60)}},r=function(){var i=(new Date).getTime();n(r);var s=(i-t)/1e3;s>1/15&&(s=1/15),e.step(s),t=i};n(r)},n.prototype.step=function(e){if(!this.running)return;this.dtRemaining+=e;while(this.dtRemaining>this.stepAmount)this.dtRemaining-=this.stepAmount,this.world.Step(this.stepAmount,8,3);this.context.clearRect(0,0,this.element.width,this.element.height),$(window).trigger("step"),this.destroyBodies();var t=this.world.GetBodyList();this.context.save(),this.context.scale(this.scale,this.scale);while(t){var n=t.GetUserData();n&&n.draw(this.context),t=t.GetNext()}this.context.restore(),this.debugDraw&&this.world.DrawDebugData()},n.prototype.debug=function(){this.debugCanvas=document.createElement("canvas"),this.debugCanvas.width=this.element.width,this.debugCanvas.height=this.element.height;var e=this.element.parentNode;e.insertBefore(this.debugCanvas,e.childNodes[0]),this.debugCanvas.style.position="absolute",this.debugContext=this.debugCanvas.getContext("2d"),this.debugDraw=new t.b2DebugDraw,this.debugDraw.SetSprite(this.debugContext),this.debugDraw.SetDrawScale(this.scale),this.debugDraw.SetFillAlpha(.5),this.debugDraw.SetLineThickness(1),this.debugDraw.SetFlags(t.b2DebugDraw.e_shapeBit|t.b2DebugDraw.e_jointBit),this.world.SetDebugDraw(this.debugDraw),this.clickCallBack!==undefined&&this.click(this.clickCallBack),this.dragNDropCalled===!0&&this.dragNDrop()},n.prototype.click=function(e){function n(n){n.preventDefault();var r={x:(n.offsetX||n.layerX)/t.scale,y:(n.offsetY||n.layerY)/t.scale};t.world.QueryPoint(function(t){e(t.GetBody(),t,r)},r)}var t=this;this.clickCallBack=e,this.debugDraw?(this.debugCanvas.addEventListener("mousedown",n),this.debugCanvas.addEventListener("touchstart",n)):(this.element.addEventListener("mousedown",n),this.element.addEventListener("touchstart",n))},n.prototype.collision=function(){this.listener=new Box2D.Dynamics.b2ContactListener,this.listener.PostSolve=function(e,t){var n=e.GetFixtureA().GetBody().GetUserData(),r=e.GetFixtureB().GetBody().GetUserData();n.contact&&n.contact(e,t,r),r.contact&&r.contact(e,t,n)},this.world.SetContactListener(this.listener)},n.prototype.dragNDrop=function(){function i(t){return point={x:(t.offsetX||t.layerX)/e.scale,y:(t.offsetY||t.layerY)/e.scale}}var e=this,n=null,r=null;this.dragNDropCalled=!0;var s=this.element;this.debugDraw&&(s=this.debugCanvas),s.addEventListener("mousedown",function(t){t.preventDefault();var r=i(t);e.world.QueryPoint(function(e){n=e.GetBody().GetUserData()},r)}),s.addEventListener("mousemove",function(s){if(!n)return;if(n.details.draggable!==undefined&&!n.details.draggable)return;var o=i(s);if(!r){var u=new Box2D.Dynamics.Joints.b2MouseJointDef;u.bodyA=e.world.GetGroundBody(),u.bodyB=n.body,u.target.Set(o.x,o.y),u.maxForce=1e5,u.timeStep=e.stepAmount,r=e.world.CreateJoint(u)}r.SetTarget(new t.b2Vec2(o.x,o.y))}),s.addEventListener("mouseup",function(t){n=null,r&&(e.world.DestroyJoint(r),r=null)})},n.prototype.distanceJoint=function(e,t){var n=e.body,r=t.body,i=new Box2D.Dynamics.Joints.b2DistanceJointDef;return i.Initialize(n,r,n.GetWorldCenter(),r.GetWorldCenter()),this.world.CreateJoint(i)},n.prototype.revoluteJoint=function(e,n,r,i){var s=e.body,o=n.body,u=new Box2D.Dynamics.Joints.b2RevoluteJointDef,i=i||{};return i!==undefined&&(u.enableLimit=i.enableLimit,i.lowerAngle!==undefined&&(u.lowerAngle=i.lowerAngle*Math.PI/180),i.upperAngle!==undefined&&(u.upperAngle=i.upperAngle*Math.PI/180),i.motorSpeed!==undefined&&(u.motorSpeed=i.motorSpeed),i.enableMotor!==undefined&&(u.enableMotor=i.enableMotor),i.maxMotorTorque!==undefined&&(u.maxMotorTorque=i.maxMotorTorque)),u.Initialize(s,o,new t.b2Vec2(r.x,r.y)),this.world.CreateJoint(u)},n.prototype.prismaticJoint=function(e,n,r,i,s,o){var u=e.body,a=n.body,f=new Box2D.Dynamics.Joints.Box2d.b2PrismaticJointDef;return f.Initialize(u,a,new t.b2Vec2(r.x,r.y),new t.b2Vec2(r.x,r.y)),s!==undefined&&o!==undefined&&(f.enableLimit=!0,f.lowerTranslation=s,f.upperTranslation=o,console.log(f)),this.world.CreateJoint(f)};var r=window.Body=function(e,n){this.physics=e,this.details=n=n||{},this.definition=new t.b2BodyDef;for(var r in this.definitionDefaults)this.definition[r]=n[r]||this.definitionDefaults[r];this.id=n.id||"",this.x=n.x||0,this.y=n.y||0,this.details.animation&&(n.x||(this.x=this.details.animation.x/e.scale+n.width/2),n.y||(this.y=this.details.animation.y/e.scale+n.height/2),n.shape||(n.shape="block")),this.definition.position=new t.b2Vec2(this.x,this.y),this.definition.linearVelocity=new t.b2Vec2(n.vx||0,n.vy||0),this.definition.userData=this,n.type=="static"?this.definition.type=t.b2Body.b2_staticBody:n.type=="kinematic"?this.definition.type=t.b2Body.b2_kinematicBody:this.definition.type=t.b2Body.b2_dynamicBody,this.body=e.world.CreateBody(this.definition),this.fixtureDef=new t.b2FixtureDef;for(var i in this.fixtureDefaults)this.fixtureDef[i]=n[i]||this.fixtureDefaults[i];n.shape=n.shape||this.defaults.shape;switch(n.shape){case"circle":n.radius=n.radius||this.defaults.radius,this.fixtureDef.shape=new t.b2CircleShape(n.radius);break;case"polygon":this.fixtureDef.shape=new t.b2PolygonShape,this.fixtureDef.shape.SetAsArray(n.points,n.points.length);break;case"block":default:n.width=n.width||this.defaults.width,n.height=n.height||this.defaults.height,this.fixtureDef.shape=new t.b2PolygonShape,this.fixtureDef.shape.SetAsBox(n.width/2,n.height/2)}this.body.CreateFixture(this.fixtureDef)};return r.prototype.defaults={shape:"block",width:2.5,height:2.5,radius:1.25},r.prototype.fixtureDefaults={density:2,friction:1,restitution:.2},r.prototype.definitionDefaults={active:!0,allowSleep:!0,angle:0,angularVelocity:0,awake:!0,bullet:!1,fixedRotation:!1},r.prototype.draw=function(e){var t=this.body.GetPosition(),n=this.body.GetAngle();e.save(),e.translate(t.x,t.y),e.rotate(n);if(this.details.color){e.fillStyle=this.details.color;switch(this.details.shape){case"circle":e.beginPath(),e.arc(0,0,this.details.radius,0,Math.PI*2),e.fill();break;case"polygon":var r=this.details.points;e.beginPath(),e.moveTo(r[0].x,r[0].y);for(var i=1;i<r.length;i++)e.lineTo(r[i].x,r[i].y);e.fill();break;case"block":e.fillRect(-this.details.width/2,-this.details.height/2,this.details.width,this.details.height);default:}}if(this.details.image){if(typeof this.details.image=="string"){var s=document.createElement("img");s.src=this.details.image,this.details.image=s}e.drawImage(this.details.image,-this.details.width/2,-this.details.height/2,this.details.width,this.details.height)}this.details.animation&&(this.details.animation.x=(t.x-this.details.width/2)*this.physics.scale,this.details.animation.y=(t.y-this.details.height/2)*this.physics.scale),e.restore()},t});