var b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw=Box2D.Dynamics.b2DebugDraw,Physics=window.Physics=function(e,t){var n=new b2Vec2(0,1);this.world=new b2World(n,!0),this.element=e,this.context=e.getContext("2d"),this.scale=t||30,this.dtRemaining=0,this.stepAmount=1/60,this.dragNDropCalled=!1,this.running=!0;var r=[];this.storeBodyForDestruction=function(e){r.push(e)},this.destroyBodies=function(){for(var e=0;e<r.length;++e)this.world.DestroyBody(r[e].body);r=[]}};Physics.prototype.destroyBody=function(e){this.storeBodyForDestruction(e)},Physics.prototype.screenBoundaries=function(e){var t=e||"transparent",n=this.element.width,r=this.element.height;new Body(this,{type:"static",x:15/this.scale*.5,y:r/this.scale*.5,height:r/this.scale,width:15/this.scale,color:t,id:"boundary"}),new Body(this,{type:"static",x:(n-7.5)/this.scale,y:r/this.scale*.5,height:r/this.scale,width:15/this.scale,color:t,id:"boundary"}),new Body(this,{type:"static",x:n/this.scale*.5,y:15/this.scale*.5,height:15/this.scale,width:n/this.scale,color:t,id:"boundary"}),new Body(this,{type:"static",x:n/this.scale*.5,y:(r-7.5)/this.scale,height:15/this.scale,width:n/this.scale,color:t,id:"boundary"})},Physics.prototype.animate=function(){var e=this,t=(new Date).getTime(),n=function(e){return window.requestAnimationFrame(e)||window.webkitRequestAnimationFrame(e)||window.mozRequestAnimationFrame(e)||function(e){window.setTimeout(e,1e3/60)}},r=function(){var i=(new Date).getTime();n(r);var s=(i-t)/1e3;s>1/15&&(s=1/15),e.step(s),t=i};n(r)},Physics.prototype.step=function(e){if(!this.running)return;this.dtRemaining+=e;while(this.dtRemaining>this.stepAmount)this.dtRemaining-=this.stepAmount,this.world.Step(this.stepAmount,8,3);this.context.clearRect(0,0,this.element.width,this.element.height),this.destroyBodies(),$(window).trigger("step");var t=this.world.GetBodyList();this.context.save(),this.context.scale(this.scale,this.scale);while(t){var n=t.GetUserData();n&&n.draw(this.context),t=t.GetNext()}this.context.restore(),this.debugDraw&&this.world.DrawDebugData()},Physics.prototype.debug=function(){this.debugCanvas=document.createElement("canvas"),this.debugCanvas.width=this.element.width,this.debugCanvas.height=this.element.height;var e=this.element.parentNode;e.insertBefore(this.debugCanvas,e.childNodes[0]),this.debugCanvas.style.position="absolute",this.debugContext=this.debugCanvas.getContext("2d"),this.debugDraw=new b2DebugDraw,this.debugDraw.SetSprite(this.debugContext),this.debugDraw.SetDrawScale(this.scale),this.debugDraw.SetFillAlpha(.5),this.debugDraw.SetLineThickness(1),this.debugDraw.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit),this.world.SetDebugDraw(this.debugDraw),this.clickCallBack!==undefined&&this.click(this.clickCallBack),this.dragNDropCalled===!0&&this.dragNDrop()},Physics.prototype.click=function(e){function n(n){n.preventDefault();var r={x:(n.offsetX||n.layerX)/t.scale,y:(n.offsetY||n.layerY)/t.scale};t.world.QueryPoint(function(t){e(t.GetBody(),t,r)},r)}var t=this;this.clickCallBack=e,this.debugDraw?(this.debugCanvas.addEventListener("mousedown",n),this.debugCanvas.addEventListener("touchstart",n)):(this.element.addEventListener("mousedown",n),this.element.addEventListener("touchstart",n))},Physics.prototype.collision=function(){this.listener=new Box2D.Dynamics.b2ContactListener,this.listener.PostSolve=function(e,t){var n=e.GetFixtureA().GetBody().GetUserData(),r=e.GetFixtureB().GetBody().GetUserData();n.contact&&n.contact(e,t,r),r.contact&&r.contact(e,t,n)},this.world.SetContactListener(this.listener)},Physics.prototype.dragNDrop=function(){function r(t){return point={x:(t.offsetX||t.layerX)/e.scale,y:(t.offsetY||t.layerY)/e.scale}}var e=this,t=null,n=null;this.dragNDropCalled=!0;var i=this.element;this.debugDraw&&(i=this.debugCanvas),i.addEventListener("mousedown",function(n){n.preventDefault();var i=r(n);e.world.QueryPoint(function(e){t=e.GetBody().GetUserData()},i)}),i.addEventListener("mousemove",function(i){if(!t)return;if(t.details.draggable!==undefined&&!t.details.draggable)return;var s=r(i);if(!n){var o=new Box2D.Dynamics.Joints.b2MouseJointDef;o.bodyA=e.world.GetGroundBody(),o.bodyB=t.body,o.target.Set(s.x,s.y),o.maxForce=1e5,o.timeStep=e.stepAmount,n=e.world.CreateJoint(o)}n.SetTarget(new b2Vec2(s.x,s.y))}),i.addEventListener("mouseup",function(r){t=null,n&&(e.world.DestroyJoint(n),n=null)})},Physics.prototype.distanceJoint=function(e,t){var n=e.body,r=t.body,i=new Box2D.Dynamics.Joints.b2DistanceJointDef;return i.Initialize(n,r,n.GetWorldCenter(),r.GetWorldCenter()),this.world.CreateJoint(i)},Physics.prototype.revoluteJoint=function(e,t,n,r){var i=e.body,s=t.body,o=new Box2D.Dynamics.Joints.b2RevoluteJointDef,r=r||{};return r!==undefined&&(o.enableLimit=r.enableLimit,r.lowerAngle!==undefined&&(o.lowerAngle=r.lowerAngle*Math.PI/180),r.upperAngle!==undefined&&(o.upperAngle=r.upperAngle*Math.PI/180),r.motorSpeed!==undefined&&(o.motorSpeed=r.motorSpeed),r.enableMotor!==undefined&&(o.enableMotor=r.enableMotor),r.maxMotorTorque!==undefined&&(o.maxMotorTorque=r.maxMotorTorque)),o.Initialize(i,s,new b2Vec2(n.x,n.y)),this.world.CreateJoint(o)},Physics.prototype.prismaticJoint=function(e,t,n,r,i,s){var o=e.body,u=t.body,a=new Box2D.Dynamics.Joints.b2PrismaticJointDef;return a.Initialize(o,u,new b2Vec2(n.x,n.y),new b2Vec2(n.x,n.y)),i!==undefined&&s!==undefined&&(a.enableLimit=!0,a.lowerTranslation=i,a.upperTranslation=s,console.log(a)),this.world.CreateJoint(a)};var Body=window.Body=function(e,t){this.details=t=t||{},this.definition=new b2BodyDef;for(var n in this.definitionDefaults)this.definition[n]=t[n]||this.definitionDefaults[n];this.id=t.id||"",this.x=t.x||0,this.y=t.y||0,this.definition.position=new b2Vec2(this.x,this.y),this.definition.linearVelocity=new b2Vec2(t.vx||0,t.vy||0),this.definition.userData=this,t.type=="static"?this.definition.type=b2Body.b2_staticBody:t.type=="kinematic"?this.definition.type=b2Body.b2_kinematicBody:this.definition.type=b2Body.b2_dynamicBody,this.body=e.world.CreateBody(this.definition),this.fixtureDef=new b2FixtureDef;for(var r in this.fixtureDefaults)this.fixtureDef[r]=t[r]||this.fixtureDefaults[r];t.shape=t.shape||this.defaults.shape;switch(t.shape){case"circle":t.radius=t.radius||this.defaults.radius,this.fixtureDef.shape=new b2CircleShape(t.radius);break;case"polygon":this.fixtureDef.shape=new b2PolygonShape,this.fixtureDef.shape.SetAsArray(t.points,t.points.length);break;case"block":default:t.width=t.width||this.defaults.width,t.height=t.height||this.defaults.height,this.fixtureDef.shape=new b2PolygonShape,this.fixtureDef.shape.SetAsBox(t.width/2,t.height/2)}this.body.CreateFixture(this.fixtureDef)};Body.prototype.defaults={shape:"block",width:2.5,height:2.5,radius:1.25},Body.prototype.fixtureDefaults={density:2,friction:1,restitution:.2},Body.prototype.definitionDefaults={active:!0,allowSleep:!0,angle:0,angularVelocity:0,awake:!0,bullet:!1,fixedRotation:!1},Body.prototype.draw=function(e){var t=this.body.GetPosition(),n=this.body.GetAngle();e.save(),e.translate(t.x,t.y),e.rotate(n);if(this.details.color){e.fillStyle=this.details.color;switch(this.details.shape){case"circle":e.beginPath(),e.arc(0,0,this.details.radius,0,Math.PI*2),e.fill();break;case"polygon":var r=this.details.points;e.beginPath(),e.moveTo(r[0].x,r[0].y);for(var i=1;i<r.length;i++)e.lineTo(r[i].x,r[i].y);e.fill();break;case"block":e.fillRect(-this.details.width/2,-this.details.height/2,this.details.width,this.details.height);default:}}if(this.details.image){if(typeof this.details.image=="string"){var s=document.createElement("img");s.src=this.details.image,this.details.image=s}e.drawImage(this.details.image,-this.details.width/2,-this.details.height/2,this.details.width,this.details.height)}e.restore()};